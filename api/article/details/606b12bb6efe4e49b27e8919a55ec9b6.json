{
    "props": {
        "pageProps": {
            "query": {
                "id": "606b12bb6efe4e49b27e8919a55ec9b6"
            },
            "ieBrowser": false,
            "needRefresh": false,
            "writingDetail": {
                "id": 82484,
                "outId": "606b12bb6efe4e49b27e8919a55ec9b6",
                "articleOutId": "606b12bb6efe4e49b27e8919a55ec9b6",
                "html": "<p data-tool=\"mdnice编辑器\" style=\"color: rgb(0, 0, 0); font-size: 16px; line-height: 1.8em; letter-spacing: 0em; text-align: left; text-indent: 0em; margin-top: 0px; margin-bottom: 0px; margin-left: 0px; margin-right: 0px; padding-top: 8px; padding-bottom: 8px; padding-left: 0px; padding-right: 0px;\"></p> \n<div class=\"table-of-contents\" data-tool=\"mdnice编辑器\"> \n <ul style=\"list-style-type: disc; margin-top: 8px; margin-bottom: 8px; margin-left: 0px; margin-right: 0px; padding-top: 0px; padding-bottom: 0px; padding-left: 25px; padding-right: 0px; color: rgb(0, 0, 0);\"> \n  <li><a href style=\"border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin-top: 0px; margin-bottom: 0px; margin-left: 0px; margin-right: 0px; padding-top: 0px; padding-bottom: 0px; padding-left: 0px; padding-right: 0px; text-decoration-line: none; text-decoration-thickness: initial; text-decoration-style: initial; text-decoration-color: initial; overflow-wrap: break-word; border-top-width: initial; border-right-width: initial; border-bottom-width: initial; border-left-width: initial; border-top-style: none; border-right-style: none; border-bottom-style: none; border-left-style: none; border-top-color: initial; border-right-color: initial; border-bottom-color: initial; border-left-color: initial; border-image-source: initial; border-image-slice: initial; border-image-width: initial; border-image-outset: initial; border-image-repeat: initial; color: rgb(0, 0, 0); font-weight: normal;\">什么是completion</a></li> \n  <li><a href style=\"border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin-top: 0px; margin-bottom: 0px; margin-left: 0px; margin-right: 0px; padding-top: 0px; padding-bottom: 0px; padding-left: 0px; padding-right: 0px; text-decoration-line: none; text-decoration-thickness: initial; text-decoration-style: initial; text-decoration-color: initial; overflow-wrap: break-word; border-top-width: initial; border-right-width: initial; border-bottom-width: initial; border-left-width: initial; border-top-style: none; border-right-style: none; border-bottom-style: none; border-left-style: none; border-top-color: initial; border-right-color: initial; border-bottom-color: initial; border-left-color: initial; border-image-source: initial; border-image-slice: initial; border-image-width: initial; border-image-outset: initial; border-image-repeat: initial; color: rgb(0, 0, 0); font-weight: normal;\">completion的函数介绍</a></li> \n  <li><a href style=\"border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin-top: 0px; margin-bottom: 0px; margin-left: 0px; margin-right: 0px; padding-top: 0px; padding-bottom: 0px; padding-left: 0px; padding-right: 0px; text-decoration-line: none; text-decoration-thickness: initial; text-decoration-style: initial; text-decoration-color: initial; overflow-wrap: break-word; border-top-width: initial; border-right-width: initial; border-bottom-width: initial; border-left-width: initial; border-top-style: none; border-right-style: none; border-bottom-style: none; border-left-style: none; border-top-color: initial; border-right-color: initial; border-bottom-color: initial; border-left-color: initial; border-image-source: initial; border-image-slice: initial; border-image-width: initial; border-image-outset: initial; border-image-repeat: initial; color: rgb(0, 0, 0); font-weight: normal;\">completion的函数使用</a></li> \n  <li><a href style=\"border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin-top: 0px; margin-bottom: 0px; margin-left: 0px; margin-right: 0px; padding-top: 0px; padding-bottom: 0px; padding-left: 0px; padding-right: 0px; text-decoration-line: none; text-decoration-thickness: initial; text-decoration-style: initial; text-decoration-color: initial; overflow-wrap: break-word; border-top-width: initial; border-right-width: initial; border-bottom-width: initial; border-left-width: initial; border-top-style: none; border-right-style: none; border-bottom-style: none; border-left-style: none; border-top-color: initial; border-right-color: initial; border-bottom-color: initial; border-left-color: initial; border-image-source: initial; border-image-slice: initial; border-image-width: initial; border-image-outset: initial; border-image-repeat: initial; color: rgb(0, 0, 0); font-weight: normal;\">总结</a></li> \n </ul> \n</div> \n<p data-tool=\"mdnice编辑器\" style=\"color: rgb(0, 0, 0); font-size: 16px; line-height: 1.8em; letter-spacing: 0em; text-align: left; text-indent: 0em; margin-top: 0px; margin-bottom: 0px; margin-left: 0px; margin-right: 0px; padding-top: 8px; padding-bottom: 8px; padding-left: 0px; padding-right: 0px;\"></p> \n<h2 data-tool=\"mdnice编辑器\" style=\"margin-top: 30px; margin-bottom: 15px; margin-left: 0px; margin-right: 0px; padding-top: 0px; padding-bottom: 0px; padding-left: 0px; padding-right: 0px; display: block;\"><span class=\"prefix\" style=\"display: none;\"></span><span class=\"content\" style=\"font-size: 22px; color: rgb(0, 0, 0); line-height: 1.5em; letter-spacing: 0em; text-align: left; font-weight: bold; display: block;\">什么是completion</span><span class=\"suffix\" style=\"display: none;\"></span></h2> \n<p data-tool=\"mdnice编辑器\" style=\"color: rgb(0, 0, 0); font-size: 16px; line-height: 1.8em; letter-spacing: 0em; text-align: left; text-indent: 0em; margin-top: 0px; margin-bottom: 0px; margin-left: 0px; margin-right: 0px; padding-top: 8px; padding-bottom: 8px; padding-left: 0px; padding-right: 0px;\">linux内核中，完成量completion是一种代码同步机制。如果有一个或多个线程必须等待某个内核活动操作达到某个点或某个特定状态，那么completion完成量可以提供一个无竞争的解决方案。</p> \n<h2 data-tool=\"mdnice编辑器\" style=\"margin-top: 30px; margin-bottom: 15px; margin-left: 0px; margin-right: 0px; padding-top: 0px; padding-bottom: 0px; padding-left: 0px; padding-right: 0px; display: block;\"><span class=\"prefix\" style=\"display: none;\"></span><span class=\"content\" style=\"font-size: 22px; color: rgb(0, 0, 0); line-height: 1.5em; letter-spacing: 0em; text-align: left; font-weight: bold; display: block;\">completion的函数介绍</span><span class=\"suffix\" style=\"display: none;\"></span></h2> \n<p data-tool=\"mdnice编辑器\" style=\"color: rgb(0, 0, 0); font-size: 16px; line-height: 1.8em; letter-spacing: 0em; text-align: left; text-indent: 0em; margin-top: 0px; margin-bottom: 0px; margin-left: 0px; margin-right: 0px; padding-top: 8px; padding-bottom: 8px; padding-left: 0px; padding-right: 0px;\"><strong style=\"color: rgb(0, 0, 0); font-weight: bold; background-attachment: scroll; background-clip: border-box; background-color: rgba(0, 0, 0, 0); background-image: none; background-origin: padding-box; background-position-x: 0%; background-position-y: 0%; background-repeat: no-repeat; background-size: auto; width: auto; height: auto; margin-top: 0px; margin-bottom: 0px; margin-left: 0px; margin-right: 0px; padding-top: 0px; padding-bottom: 0px; padding-left: 0px; padding-right: 0px; border-top-style: none; border-bottom-style: none; border-left-style: none; border-right-style: none; border-top-width: 3px; border-bottom-width: 3px; border-left-width: 3px; border-right-width: 3px; border-top-color: rgba(0, 0, 0, 0.4); border-bottom-color: rgba(0, 0, 0, 0.4); border-left-color: rgba(0, 0, 0, 0.4); border-right-color: rgba(0, 0, 0, 0.4); border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px;\">定义并初始化完成量</strong></p> \n<p data-tool=\"mdnice编辑器\" style=\"color: rgb(0, 0, 0); font-size: 16px; line-height: 1.8em; letter-spacing: 0em; text-align: left; text-indent: 0em; margin-top: 0px; margin-bottom: 0px; margin-left: 0px; margin-right: 0px; padding-top: 8px; padding-bottom: 8px; padding-left: 0px; padding-right: 0px;\">// 方式一动态创建</p> \n<pre class=\"custom\" data-tool=\"mdnice编辑器\" style=\"border-radius: 5px; box-shadow: rgba(0, 0, 0, 0.55) 0px 2px 10px; text-align: left; margin-top: 10px; margin-bottom: 10px; margin-left: 0px; margin-right: 0px; padding-top: 0px; padding-bottom: 0px; padding-left: 0px; padding-right: 0px;\"><span style=\"display: block; background: url(https://files.mdnice.com/user/3441/876cad08-0422-409d-bb5a-08afec5da8ee.svg); height: 30px; width: 100%; background-size: 40px; background-repeat: no-repeat; background-color: #282c34; margin-bottom: -7px; border-radius: 5px; background-position: 10px 10px;\"></span><code class=\"hljs\" style=\"overflow-x: auto; padding: 16px; color: #abb2bf; padding-top: 15px; background: #282c34; border-radius: 5px; display: -webkit-box; font-family: Consolas, Monaco, Menlo, monospace; font-size: 12px;\">struct&nbsp;completion&nbsp;mycompletion;<br>init_completion(&amp;mycompletion)<br></code></pre> \n<p data-tool=\"mdnice编辑器\" style=\"color: rgb(0, 0, 0); font-size: 16px; line-height: 1.8em; letter-spacing: 0em; text-align: left; text-indent: 0em; margin-top: 0px; margin-bottom: 0px; margin-left: 0px; margin-right: 0px; padding-top: 8px; padding-bottom: 8px; padding-left: 0px; padding-right: 0px;\">// 方式二静态创建</p> \n<pre class=\"custom\" data-tool=\"mdnice编辑器\" style=\"border-radius: 5px; box-shadow: rgba(0, 0, 0, 0.55) 0px 2px 10px; text-align: left; margin-top: 10px; margin-bottom: 10px; margin-left: 0px; margin-right: 0px; padding-top: 0px; padding-bottom: 0px; padding-left: 0px; padding-right: 0px;\"><span style=\"display: block; background: url(https://files.mdnice.com/user/3441/876cad08-0422-409d-bb5a-08afec5da8ee.svg); height: 30px; width: 100%; background-size: 40px; background-repeat: no-repeat; background-color: #282c34; margin-bottom: -7px; border-radius: 5px; background-position: 10px 10px;\"></span><code class=\"hljs\" style=\"overflow-x: auto; padding: 16px; color: #abb2bf; padding-top: 15px; background: #282c34; border-radius: 5px; display: -webkit-box; font-family: Consolas, Monaco, Menlo, monospace; font-size: 12px;\">DECLARE_COMPLETION(mycompletion);<br></code></pre> \n<p data-tool=\"mdnice编辑器\" style=\"color: rgb(0, 0, 0); font-size: 16px; line-height: 1.8em; letter-spacing: 0em; text-align: left; text-indent: 0em; margin-top: 0px; margin-bottom: 0px; margin-left: 0px; margin-right: 0px; padding-top: 8px; padding-bottom: 8px; padding-left: 0px; padding-right: 0px;\">以下两种方式是等效的，都实现了定义和初始化完成量mycompletion的功能。</p> \n<p data-tool=\"mdnice编辑器\" style=\"color: rgb(0, 0, 0); font-size: 16px; line-height: 1.8em; letter-spacing: 0em; text-align: left; text-indent: 0em; margin-top: 0px; margin-bottom: 0px; margin-left: 0px; margin-right: 0px; padding-top: 8px; padding-bottom: 8px; padding-left: 0px; padding-right: 0px;\"><strong style=\"color: rgb(0, 0, 0); font-weight: bold; background-attachment: scroll; background-clip: border-box; background-color: rgba(0, 0, 0, 0); background-image: none; background-origin: padding-box; background-position-x: 0%; background-position-y: 0%; background-repeat: no-repeat; background-size: auto; width: auto; height: auto; margin-top: 0px; margin-bottom: 0px; margin-left: 0px; margin-right: 0px; padding-top: 0px; padding-bottom: 0px; padding-left: 0px; padding-right: 0px; border-top-style: none; border-bottom-style: none; border-left-style: none; border-right-style: none; border-top-width: 3px; border-bottom-width: 3px; border-left-width: 3px; border-right-width: 3px; border-top-color: rgba(0, 0, 0, 0.4); border-bottom-color: rgba(0, 0, 0, 0.4); border-left-color: rgba(0, 0, 0, 0.4); border-right-color: rgba(0, 0, 0, 0.4); border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px;\">等待完成量</strong></p> \n<pre class=\"custom\" data-tool=\"mdnice编辑器\" style=\"border-radius: 5px; box-shadow: rgba(0, 0, 0, 0.55) 0px 2px 10px; text-align: left; margin-top: 10px; margin-bottom: 10px; margin-left: 0px; margin-right: 0px; padding-top: 0px; padding-bottom: 0px; padding-left: 0px; padding-right: 0px;\"><span style=\"display: block; background: url(https://files.mdnice.com/user/3441/876cad08-0422-409d-bb5a-08afec5da8ee.svg); height: 30px; width: 100%; background-size: 40px; background-repeat: no-repeat; background-color: #282c34; margin-bottom: -7px; border-radius: 5px; background-position: 10px 10px;\"></span><code class=\"hljs\" style=\"overflow-x: auto; padding: 16px; color: #abb2bf; padding-top: 15px; background: #282c34; border-radius: 5px; display: -webkit-box; font-family: Consolas, Monaco, Menlo, monospace; font-size: 12px;\">wait_for_completion(&amp;mycompletion);<br>wait_for_completion_interruptible(&amp;mycompletion);<br>wait_for_completion_timeout(&amp;mycompletion,timeout);<br></code></pre> \n<p data-tool=\"mdnice编辑器\" style=\"color: rgb(0, 0, 0); font-size: 16px; line-height: 1.8em; letter-spacing: 0em; text-align: left; text-indent: 0em; margin-top: 0px; margin-bottom: 0px; margin-left: 0px; margin-right: 0px; padding-top: 8px; padding-bottom: 8px; padding-left: 0px; padding-right: 0px;\">三者区别：</p> \n<ul data-tool=\"mdnice编辑器\" style=\"list-style-type: disc; margin-top: 8px; margin-bottom: 8px; margin-left: 0px; margin-right: 0px; padding-top: 0px; padding-bottom: 0px; padding-left: 25px; padding-right: 0px; color: rgb(0, 0, 0);\"> \n <li> \n  <section style=\"margin-top: 5px; margin-bottom: 5px; color: rgb(1, 1, 1); font-size: 16px; line-height: 1.8em; letter-spacing: 0em; text-align: left; font-weight: normal;\">\n    wait_for_completion是不可中断的（non-interruptible），这意味着无论是否收到中断信号，当前线程都会一直等待完成量的完成。此外，该函数也没有超时功能，即使等待时间很长，也不会自动超时返回。 \n  </section></li> \n <li> \n  <section style=\"margin-top: 5px; margin-bottom: 5px; color: rgb(1, 1, 1); font-size: 16px; line-height: 1.8em; letter-spacing: 0em; text-align: left; font-weight: normal;\">\n    wait_for_completion_interruptible等待完成量期间如果收到中断信号会立马返回 \n  </section></li> \n <li> \n  <section style=\"margin-top: 5px; margin-bottom: 5px; color: rgb(1, 1, 1); font-size: 16px; line-height: 1.8em; letter-spacing: 0em; text-align: left; font-weight: normal;\">\n    wait_for_completion_timeout等待timeout时间后自动超时返回 <strong style=\"color: rgb(0, 0, 0); font-weight: bold; background-attachment: scroll; background-clip: border-box; background-color: rgba(0, 0, 0, 0); background-image: none; background-origin: padding-box; background-position-x: 0%; background-position-y: 0%; background-repeat: no-repeat; background-size: auto; width: auto; height: auto; margin-top: 0px; margin-bottom: 0px; margin-left: 0px; margin-right: 0px; padding-top: 0px; padding-bottom: 0px; padding-left: 0px; padding-right: 0px; border-top-style: none; border-bottom-style: none; border-left-style: none; border-right-style: none; border-top-width: 3px; border-bottom-width: 3px; border-left-width: 3px; border-right-width: 3px; border-top-color: rgba(0, 0, 0, 0.4); border-bottom-color: rgba(0, 0, 0, 0.4); border-left-color: rgba(0, 0, 0, 0.4); border-right-color: rgba(0, 0, 0, 0.4); border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px;\">唤醒完成量</strong> \n  </section></li> \n</ul> \n<pre class=\"custom\" data-tool=\"mdnice编辑器\" style=\"border-radius: 5px; box-shadow: rgba(0, 0, 0, 0.55) 0px 2px 10px; text-align: left; margin-top: 10px; margin-bottom: 10px; margin-left: 0px; margin-right: 0px; padding-top: 0px; padding-bottom: 0px; padding-left: 0px; padding-right: 0px;\"><span style=\"display: block; background: url(https://files.mdnice.com/user/3441/876cad08-0422-409d-bb5a-08afec5da8ee.svg); height: 30px; width: 100%; background-size: 40px; background-repeat: no-repeat; background-color: #282c34; margin-bottom: -7px; border-radius: 5px; background-position: 10px 10px;\"></span><code class=\"hljs\" style=\"overflow-x: auto; padding: 16px; color: #abb2bf; padding-top: 15px; background: #282c34; border-radius: 5px; display: -webkit-box; font-family: Consolas, Monaco, Menlo, monospace; font-size: 12px;\">complete(&amp;mycompletion);<br></code></pre> \n<p data-tool=\"mdnice编辑器\" style=\"color: rgb(0, 0, 0); font-size: 16px; line-height: 1.8em; letter-spacing: 0em; text-align: left; text-indent: 0em; margin-top: 0px; margin-bottom: 0px; margin-left: 0px; margin-right: 0px; padding-top: 8px; padding-bottom: 8px; padding-left: 0px; padding-right: 0px;\">complete函数用于唤醒等待此特定complete事件的单个线程</p> \n<h2 data-tool=\"mdnice编辑器\" style=\"margin-top: 30px; margin-bottom: 15px; margin-left: 0px; margin-right: 0px; padding-top: 0px; padding-bottom: 0px; padding-left: 0px; padding-right: 0px; display: block;\"><span class=\"prefix\" style=\"display: none;\"></span><span class=\"content\" style=\"font-size: 22px; color: rgb(0, 0, 0); line-height: 1.5em; letter-spacing: 0em; text-align: left; font-weight: bold; display: block;\">completion的函数使用</span><span class=\"suffix\" style=\"display: none;\"></span></h2> \n<p data-tool=\"mdnice编辑器\" style=\"color: rgb(0, 0, 0); font-size: 16px; line-height: 1.8em; letter-spacing: 0em; text-align: left; text-indent: 0em; margin-top: 0px; margin-bottom: 0px; margin-left: 0px; margin-right: 0px; padding-top: 8px; padding-bottom: 8px; padding-left: 0px; padding-right: 0px;\">写了个demo,应用里起两个线程，一个线程用于写，另外一个线程用于读，等写完成后再进行读操作 app:</p> \n<pre class=\"custom\" data-tool=\"mdnice编辑器\" style=\"border-radius: 5px; box-shadow: rgba(0, 0, 0, 0.55) 0px 2px 10px; text-align: left; margin-top: 10px; margin-bottom: 10px; margin-left: 0px; margin-right: 0px; padding-top: 0px; padding-bottom: 0px; padding-left: 0px; padding-right: 0px;\"><span style=\"display: block; background: url(https://files.mdnice.com/user/3441/876cad08-0422-409d-bb5a-08afec5da8ee.svg); height: 30px; width: 100%; background-size: 40px; background-repeat: no-repeat; background-color: #282c34; margin-bottom: -7px; border-radius: 5px; background-position: 10px 10px;\"></span><code class=\"hljs\" style=\"overflow-x: auto; padding: 16px; color: #abb2bf; padding-top: 15px; background: #282c34; border-radius: 5px; display: -webkit-box; font-family: Consolas, Monaco, Menlo, monospace; font-size: 12px;\"><span class=\"hljs-comment\" style=\"color: #5c6370; font-style: italic; line-height: 26px;\">#include&nbsp;&lt;stdint.h&gt;</span><br><span class=\"hljs-comment\" style=\"color: #5c6370; font-style: italic; line-height: 26px;\">#include&nbsp;&lt;sys/types.h&gt;</span><br><span class=\"hljs-comment\" style=\"color: #5c6370; font-style: italic; line-height: 26px;\">#include&nbsp;&lt;stdlib.h&gt;</span><br><span class=\"hljs-comment\" style=\"color: #5c6370; font-style: italic; line-height: 26px;\">#include&nbsp;&lt;unistd.h&gt;</span><br><span class=\"hljs-comment\" style=\"color: #5c6370; font-style: italic; line-height: 26px;\">#include&nbsp;&lt;fcntl.h&gt;</span><br><span class=\"hljs-comment\" style=\"color: #5c6370; font-style: italic; line-height: 26px;\">#include&nbsp;&lt;string.h&gt;</span><br><span class=\"hljs-comment\" style=\"color: #5c6370; font-style: italic; line-height: 26px;\">#include&nbsp;&lt;sys/ioctl.h&gt;</span><br><span class=\"hljs-comment\" style=\"color: #5c6370; font-style: italic; line-height: 26px;\">#include&nbsp;&lt;unistd.h&gt;</span><br><span class=\"hljs-comment\" style=\"color: #5c6370; font-style: italic; line-height: 26px;\">#include&nbsp;&lt;stdio.h&gt;</span><br><span class=\"hljs-comment\" style=\"color: #5c6370; font-style: italic; line-height: 26px;\">#include&nbsp;&lt;pthread.h&gt;</span><br><span class=\"hljs-comment\" style=\"color: #5c6370; font-style: italic; line-height: 26px;\">#include&nbsp;&lt;poll.h&gt;</span><br><br><span class=\"hljs-comment\" style=\"color: #5c6370; font-style: italic; line-height: 26px;\">#define&nbsp;DELAY_CMD_0_WRITE&nbsp;&nbsp;&nbsp;_IOW('A',0,unsigned&nbsp;int)</span><br><span class=\"hljs-comment\" style=\"color: #5c6370; font-style: italic; line-height: 26px;\">#define&nbsp;DELAY_CMD_1_READ&nbsp;&nbsp;&nbsp;_IOW('A',1,unsigned&nbsp;int)</span><br><br>static&nbsp;void*&nbsp;write(void&nbsp;*ptr)&nbsp;<br>{<br>&nbsp;int&nbsp;fd&nbsp;=&nbsp;open(<span class=\"hljs-string\" style=\"color: #98c379; line-height: 26px;\">\"/dev/hello\"</span>,&nbsp;O_RDWR,&nbsp;O_NONBLOCK);<br>&nbsp;<span class=\"hljs-keyword\" style=\"color: #c678dd; line-height: 26px;\">if</span>&nbsp;(fd&nbsp;&lt;&nbsp;0)&nbsp;{<br>&nbsp;&nbsp;perror(<span class=\"hljs-string\" style=\"color: #98c379; line-height: 26px;\">\"open\"</span>);<br>&nbsp;&nbsp;<span class=\"hljs-built_in\" style=\"color: #e6c07b; line-height: 26px;\">printf</span>(<span class=\"hljs-string\" style=\"color: #98c379; line-height: 26px;\">\"error&nbsp;open\\n\"</span>);<br>&nbsp;&nbsp;<span class=\"hljs-built_in\" style=\"color: #e6c07b; line-height: 26px;\">return</span>&nbsp;NULL;<br>&nbsp;}<br>&nbsp;<span class=\"hljs-built_in\" style=\"color: #e6c07b; line-height: 26px;\">printf</span>(<span class=\"hljs-string\" style=\"color: #98c379; line-height: 26px;\">\"write&nbsp;start&nbsp;\\n\"</span>);<br>&nbsp;ioctl(fd,&nbsp;DELAY_CMD_0_WRITE,&nbsp;100);<br>&nbsp;<span class=\"hljs-built_in\" style=\"color: #e6c07b; line-height: 26px;\">printf</span>(<span class=\"hljs-string\" style=\"color: #98c379; line-height: 26px;\">\"write&nbsp;end&nbsp;\\n\"</span>);<br>&nbsp;close(fd);<br>}<br><br>static&nbsp;void*&nbsp;<span class=\"hljs-built_in\" style=\"color: #e6c07b; line-height: 26px;\">read</span>(void&nbsp;*ptr)&nbsp;<br>{<br>&nbsp;int&nbsp;fd&nbsp;=&nbsp;open(<span class=\"hljs-string\" style=\"color: #98c379; line-height: 26px;\">\"/dev/hello\"</span>,&nbsp;O_RDWR,&nbsp;O_NONBLOCK);<br>&nbsp;<span class=\"hljs-keyword\" style=\"color: #c678dd; line-height: 26px;\">if</span>&nbsp;(fd&nbsp;&lt;&nbsp;0)&nbsp;{<br>&nbsp;&nbsp;perror(<span class=\"hljs-string\" style=\"color: #98c379; line-height: 26px;\">\"open\"</span>);<br>&nbsp;&nbsp;<span class=\"hljs-built_in\" style=\"color: #e6c07b; line-height: 26px;\">printf</span>(<span class=\"hljs-string\" style=\"color: #98c379; line-height: 26px;\">\"error&nbsp;open\\n\"</span>);<br>&nbsp;&nbsp;<span class=\"hljs-built_in\" style=\"color: #e6c07b; line-height: 26px;\">return</span>&nbsp;NULL;<br>&nbsp;}<br>&nbsp;<span class=\"hljs-built_in\" style=\"color: #e6c07b; line-height: 26px;\">printf</span>(<span class=\"hljs-string\" style=\"color: #98c379; line-height: 26px;\">\"read&nbsp;start&nbsp;\\n\"</span>);<br>&nbsp;ioctl(fd,&nbsp;DELAY_CMD_1_READ,&nbsp;100);<br>&nbsp;<span class=\"hljs-built_in\" style=\"color: #e6c07b; line-height: 26px;\">printf</span>(<span class=\"hljs-string\" style=\"color: #98c379; line-height: 26px;\">\"read&nbsp;end&nbsp;\\n\"</span>);<br>&nbsp;close(fd);<br>}<br><br>/**<br>&nbsp;*&nbsp;first&nbsp;<span class=\"hljs-built_in\" style=\"color: #e6c07b; line-height: 26px;\">read</span>&nbsp;<span class=\"hljs-keyword\" style=\"color: #c678dd; line-height: 26px;\">then</span>&nbsp;&nbsp;write<br>&nbsp;*/<br>int&nbsp;<span class=\"hljs-function\" style=\"line-height: 26px;\"><span class=\"hljs-title\" style=\"color: #61aeee; line-height: 26px;\">main</span></span>()&nbsp;<br>{<br>&nbsp;pthread_t&nbsp;thread,&nbsp;thread2;<br>&nbsp;pthread_create(&amp;thread,&nbsp;NULL,&nbsp;write01,&nbsp;NULL);<br>&nbsp;sleep(2);<br>&nbsp;pthread_create(&amp;thread2,&nbsp;NULL,&nbsp;read01,&nbsp;NULL);<br>&nbsp;pthread_join(thread,&nbsp;NULL);<br>&nbsp;pthread_join(thread2,&nbsp;NULL);<br>&nbsp;<span class=\"hljs-built_in\" style=\"color: #e6c07b; line-height: 26px;\">printf</span>(<span class=\"hljs-string\" style=\"color: #98c379; line-height: 26px;\">\"main&nbsp;exit\\n\"</span>);<br>&nbsp;<span class=\"hljs-built_in\" style=\"color: #e6c07b; line-height: 26px;\">return</span>&nbsp;0;<br>}<br><br></code></pre> \n<p data-tool=\"mdnice编辑器\" style=\"color: rgb(0, 0, 0); font-size: 16px; line-height: 1.8em; letter-spacing: 0em; text-align: left; text-indent: 0em; margin-top: 0px; margin-bottom: 0px; margin-left: 0px; margin-right: 0px; padding-top: 8px; padding-bottom: 8px; padding-left: 0px; padding-right: 0px;\">driver:</p> \n<pre class=\"custom\" data-tool=\"mdnice编辑器\" style=\"border-radius: 5px; box-shadow: rgba(0, 0, 0, 0.55) 0px 2px 10px; text-align: left; margin-top: 10px; margin-bottom: 10px; margin-left: 0px; margin-right: 0px; padding-top: 0px; padding-bottom: 0px; padding-left: 0px; padding-right: 0px;\"><span style=\"display: block; background: url(https://files.mdnice.com/user/3441/876cad08-0422-409d-bb5a-08afec5da8ee.svg); height: 30px; width: 100%; background-size: 40px; background-repeat: no-repeat; background-color: #282c34; margin-bottom: -7px; border-radius: 5px; background-position: 10px 10px;\"></span><code class=\"hljs\" style=\"overflow-x: auto; padding: 16px; color: #abb2bf; padding-top: 15px; background: #282c34; border-radius: 5px; display: -webkit-box; font-family: Consolas, Monaco, Menlo, monospace; font-size: 12px;\"><span class=\"hljs-comment\" style=\"color: #5c6370; font-style: italic; line-height: 26px;\">#include&nbsp;&lt;linux/uaccess.h&gt;</span><br><span class=\"hljs-comment\" style=\"color: #5c6370; font-style: italic; line-height: 26px;\">#include&nbsp;&lt;linux/fs.h&gt;</span><br><span class=\"hljs-comment\" style=\"color: #5c6370; font-style: italic; line-height: 26px;\">#include&nbsp;&lt;linux/stat.h&gt;</span><br><span class=\"hljs-comment\" style=\"color: #5c6370; font-style: italic; line-height: 26px;\">#include&nbsp;&lt;linux/cdev.h&gt;</span><br><span class=\"hljs-comment\" style=\"color: #5c6370; font-style: italic; line-height: 26px;\">#include&nbsp;&lt;linux/io.h&gt;</span><br><span class=\"hljs-comment\" style=\"color: #5c6370; font-style: italic; line-height: 26px;\">#include&nbsp;&lt;linux/gpio.h&gt;</span><br><span class=\"hljs-comment\" style=\"color: #5c6370; font-style: italic; line-height: 26px;\">#include&nbsp;&lt;linux/slab.h&gt;</span><br><span class=\"hljs-comment\" style=\"color: #5c6370; font-style: italic; line-height: 26px;\">#include&nbsp;&lt;linux/irq.h&gt;</span><br><span class=\"hljs-comment\" style=\"color: #5c6370; font-style: italic; line-height: 26px;\">#include&nbsp;&lt;linux/mutex.h&gt;</span><br><span class=\"hljs-comment\" style=\"color: #5c6370; font-style: italic; line-height: 26px;\">#include&nbsp;&lt;linux/interrupt.h&gt;</span><br><span class=\"hljs-comment\" style=\"color: #5c6370; font-style: italic; line-height: 26px;\">#include&nbsp;&lt;linux/bug.h&gt;&nbsp;&nbsp;&nbsp;/*&nbsp;For&nbsp;BUG_ON.&nbsp;&nbsp;*/</span><br><span class=\"hljs-comment\" style=\"color: #5c6370; font-style: italic; line-height: 26px;\">#include&nbsp;&lt;linux/cpu.h&gt;</span><br><span class=\"hljs-comment\" style=\"color: #5c6370; font-style: italic; line-height: 26px;\">#include&nbsp;&lt;linux/init.h&gt;&nbsp;/*&nbsp;Needed&nbsp;for&nbsp;the&nbsp;macros&nbsp;*/</span><br><span class=\"hljs-comment\" style=\"color: #5c6370; font-style: italic; line-height: 26px;\">#include&nbsp;&lt;linux/kernel.h&gt;&nbsp;/*&nbsp;Needed&nbsp;for&nbsp;pr_info()&nbsp;*/</span><br><span class=\"hljs-comment\" style=\"color: #5c6370; font-style: italic; line-height: 26px;\">#include&nbsp;&lt;linux/module.h&gt;&nbsp;/*&nbsp;Needed&nbsp;by&nbsp;all&nbsp;modules&nbsp;*/</span><br><span class=\"hljs-comment\" style=\"color: #5c6370; font-style: italic; line-height: 26px;\">#include&nbsp;&lt;linux/delay.h&gt;</span><br><span class=\"hljs-comment\" style=\"color: #5c6370; font-style: italic; line-height: 26px;\">#include&nbsp;&lt;linux/smp.h&gt;</span><br><span class=\"hljs-comment\" style=\"color: #5c6370; font-style: italic; line-height: 26px;\">#include&nbsp;&lt;linux/kernel_stat.h&gt;</span><br><span class=\"hljs-comment\" style=\"color: #5c6370; font-style: italic; line-height: 26px;\">#include&nbsp;&lt;linux/sched.h&gt;</span><br><span class=\"hljs-comment\" style=\"color: #5c6370; font-style: italic; line-height: 26px;\">#include&nbsp;&lt;linux/percpu-defs.h&gt;</span><br><span class=\"hljs-comment\" style=\"color: #5c6370; font-style: italic; line-height: 26px;\">#include&nbsp;&lt;linux/wait.h&gt;</span><br><span class=\"hljs-comment\" style=\"color: #5c6370; font-style: italic; line-height: 26px;\">#include&nbsp;&lt;linux/gpio/driver.h&gt;</span><br><span class=\"hljs-comment\" style=\"color: #5c6370; font-style: italic; line-height: 26px;\">#include&nbsp;&lt;linux/atomic.h&gt;</span><br><span class=\"hljs-comment\" style=\"color: #5c6370; font-style: italic; line-height: 26px;\">#include&nbsp;&lt;linux/platform_device.h&gt;</span><br><span class=\"hljs-comment\" style=\"color: #5c6370; font-style: italic; line-height: 26px;\">#include&nbsp;&lt;linux/poll.h&gt;</span><br><span class=\"hljs-comment\" style=\"color: #5c6370; font-style: italic; line-height: 26px;\">#include&nbsp;&lt;linux/kfifo.h&gt;</span><br><span class=\"hljs-comment\" style=\"color: #5c6370; font-style: italic; line-height: 26px;\">#include&nbsp;&lt;linux/completion.h&gt;</span><br><br><span class=\"hljs-comment\" style=\"color: #5c6370; font-style: italic; line-height: 26px;\">#define&nbsp;DELAY_CMD_WRITE&nbsp;&nbsp;&nbsp;_IOW('A',0,unsigned&nbsp;int)</span><br><span class=\"hljs-comment\" style=\"color: #5c6370; font-style: italic; line-height: 26px;\">#define&nbsp;DELAY_CMD_READ&nbsp;&nbsp;&nbsp;_IOW('A',1,unsigned&nbsp;int)</span><br><span class=\"hljs-comment\" style=\"color: #5c6370; font-style: italic; line-height: 26px;\">#define&nbsp;ERROR&nbsp;&nbsp;(-1)</span><br><br>DEFINE_KFIFO(myfifo,&nbsp;char,&nbsp;1024);<br><br>dev_t&nbsp;devid;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;起始设备编号<br>struct&nbsp;cdev&nbsp;hello_cdev;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;保存操作结构体的字符设备&nbsp;<br>struct&nbsp;class&nbsp;*hello_cls;<br><br>DECLARE_WAIT_QUEUE_HEAD(wq);<br><br>static&nbsp;int&nbsp;hello_open(struct&nbsp;inode&nbsp;*inode,&nbsp;struct&nbsp;file&nbsp;*file)&nbsp;<br>{<br>&nbsp;pr_info(<span class=\"hljs-string\" style=\"color: #98c379; line-height: 26px;\">\"hello_open&nbsp;\\n\"</span>);<br>&nbsp;<span class=\"hljs-built_in\" style=\"color: #e6c07b; line-height: 26px;\">return</span>&nbsp;0;<br>}<br><br>static&nbsp;ssize_t&nbsp;hello_write(struct&nbsp;file&nbsp;*filp,&nbsp;const&nbsp;char&nbsp;__user&nbsp;*user_buffer,<br>&nbsp;&nbsp;size_t&nbsp;size,&nbsp;loff_t&nbsp;*offset)&nbsp;<br>{<br>&nbsp;int&nbsp;ret;<br>&nbsp;unsigned&nbsp;int&nbsp;len&nbsp;=&nbsp;0;<br>&nbsp;pr_info(<span class=\"hljs-string\" style=\"color: #98c379; line-height: 26px;\">\"write\"</span>);<br>&nbsp;ret&nbsp;=&nbsp;kfifo_from_user(&amp;myfifo,&nbsp;user_buffer,&nbsp;size,&nbsp;&amp;len);<br>&nbsp;<span class=\"hljs-keyword\" style=\"color: #c678dd; line-height: 26px;\">if</span>&nbsp;(ret&nbsp;!=&nbsp;0)&nbsp;{<br>&nbsp;&nbsp;pr_err(<span class=\"hljs-string\" style=\"color: #98c379; line-height: 26px;\">\"kfifo_from_user&nbsp;error\"</span>);<br>&nbsp;&nbsp;<span class=\"hljs-built_in\" style=\"color: #e6c07b; line-height: 26px;\">return</span>&nbsp;0;<br>&nbsp;}<br>&nbsp;<span class=\"hljs-keyword\" style=\"color: #c678dd; line-height: 26px;\">if</span>&nbsp;(len&nbsp;&lt;=&nbsp;0)<br>&nbsp;&nbsp;<span class=\"hljs-built_in\" style=\"color: #e6c07b; line-height: 26px;\">return</span>&nbsp;0;<br>&nbsp;*offset&nbsp;+=&nbsp;len;<br>&nbsp;wake_up(&amp;wq);<br>&nbsp;<span class=\"hljs-built_in\" style=\"color: #e6c07b; line-height: 26px;\">return</span>&nbsp;len;<br>}<br><br>static&nbsp;ssize_t&nbsp;hello_read(struct&nbsp;file&nbsp;*filp,&nbsp;char&nbsp;__user&nbsp;*user_buffer,<br>&nbsp;&nbsp;size_t&nbsp;count,&nbsp;loff_t&nbsp;*offset)&nbsp;<br>{<br>&nbsp;int&nbsp;ret;<br>&nbsp;unsigned&nbsp;int&nbsp;len&nbsp;=&nbsp;0;<br>&nbsp;pr_info(<span class=\"hljs-string\" style=\"color: #98c379; line-height: 26px;\">\"read\"</span>);<br>&nbsp;ret&nbsp;=&nbsp;kfifo_to_user(&amp;myfifo,&nbsp;user_buffer,&nbsp;count,&nbsp;&amp;len);<br>&nbsp;<span class=\"hljs-keyword\" style=\"color: #c678dd; line-height: 26px;\">if</span>&nbsp;(len&nbsp;&lt;=&nbsp;0)<br>&nbsp;&nbsp;<span class=\"hljs-built_in\" style=\"color: #e6c07b; line-height: 26px;\">return</span>&nbsp;0;<br>&nbsp;*offset&nbsp;+=&nbsp;len;<br>&nbsp;<span class=\"hljs-built_in\" style=\"color: #e6c07b; line-height: 26px;\">return</span>&nbsp;len;<br>}<br><br>unsigned&nbsp;int&nbsp;hello_poll(struct&nbsp;file&nbsp;*flip,&nbsp;struct&nbsp;poll_table_struct&nbsp;*table)&nbsp;<br>{<br>&nbsp;int&nbsp;mask&nbsp;=&nbsp;0;<br>&nbsp;pr_info(<span class=\"hljs-string\" style=\"color: #98c379; line-height: 26px;\">\"hello_poll&nbsp;\\n\"</span>);<br>&nbsp;poll_wait(flip,&nbsp;&amp;wq,&nbsp;table);<br>&nbsp;<span class=\"hljs-keyword\" style=\"color: #c678dd; line-height: 26px;\">if</span>&nbsp;(kfifo_is_empty(&amp;myfifo))&nbsp;{<br><br>&nbsp;}&nbsp;<span class=\"hljs-keyword\" style=\"color: #c678dd; line-height: 26px;\">else</span>&nbsp;{<br>&nbsp;&nbsp;mask&nbsp;|=&nbsp;POLLIN&nbsp;|&nbsp;POLLRDNORM;<br>&nbsp;}<br>&nbsp;<span class=\"hljs-built_in\" style=\"color: #e6c07b; line-height: 26px;\">return</span>&nbsp;mask;<br>}<br><br>int&nbsp;hello_close(struct&nbsp;inode&nbsp;*inode,&nbsp;struct&nbsp;file&nbsp;*flip)&nbsp;<br>{<br>&nbsp;pr_info(<span class=\"hljs-string\" style=\"color: #98c379; line-height: 26px;\">\"hello_close&nbsp;\\n\"</span>);<br>&nbsp;<span class=\"hljs-built_in\" style=\"color: #e6c07b; line-height: 26px;\">return</span>&nbsp;0;<br>}<br><br>//&nbsp;定义并初始化完成量<br>DECLARE_COMPLETION(mycompletion);<br><br>static&nbsp;long&nbsp;hello_ioctl(struct&nbsp;file&nbsp;*file,&nbsp;unsigned&nbsp;int&nbsp;cmd,&nbsp;unsigned&nbsp;long&nbsp;arg)&nbsp;<br>{<br>&nbsp;pr_info(<span class=\"hljs-string\" style=\"color: #98c379; line-height: 26px;\">\"cmd&nbsp;%d\\n\"</span>,&nbsp;cmd);<br>&nbsp;switch&nbsp;(_IOC_NR(cmd))&nbsp;{<br>&nbsp;&nbsp;<span class=\"hljs-keyword\" style=\"color: #c678dd; line-height: 26px;\">case</span>&nbsp;0:&nbsp;{<br>&nbsp;&nbsp;&nbsp;pr_info(<span class=\"hljs-string\" style=\"color: #98c379; line-height: 26px;\">\"i&nbsp;am&nbsp;waiting&nbsp;\\n\"</span>);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;等待完成量<br>&nbsp;&nbsp;&nbsp;wait_for_completion(&amp;mycompletion);<br>&nbsp;&nbsp;&nbsp;pr_info(<span class=\"hljs-string\" style=\"color: #98c379; line-height: 26px;\">\"haha,i&nbsp;get&nbsp;the&nbsp;message\\n\"</span>);<br>&nbsp;&nbsp;&nbsp;<span class=\"hljs-built_in\" style=\"color: #e6c07b; line-height: 26px;\">break</span>;<br>&nbsp;&nbsp;}<br>&nbsp;&nbsp;<span class=\"hljs-keyword\" style=\"color: #c678dd; line-height: 26px;\">case</span>&nbsp;1:&nbsp;{<br>&nbsp;&nbsp;&nbsp;pr_info(<span class=\"hljs-string\" style=\"color: #98c379; line-height: 26px;\">\"complete&nbsp;\\n\"</span>);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;唤醒完成量<br>&nbsp;&nbsp;&nbsp;complete(&amp;mycompletion);<br>&nbsp;&nbsp;&nbsp;<span class=\"hljs-built_in\" style=\"color: #e6c07b; line-height: 26px;\">break</span>;<br>&nbsp;&nbsp;}<br>&nbsp;&nbsp;default:&nbsp;{<br>&nbsp;&nbsp;&nbsp;pr_info(<span class=\"hljs-string\" style=\"color: #98c379; line-height: 26px;\">\"default:&nbsp;\\n\"</span>);<br>&nbsp;&nbsp;}<br>&nbsp;}<br>&nbsp;<span class=\"hljs-built_in\" style=\"color: #e6c07b; line-height: 26px;\">return</span>&nbsp;0;<br>}<br><br>static&nbsp;const&nbsp;struct&nbsp;file_operations&nbsp;hello_fops&nbsp;=&nbsp;{&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;.owner&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;THIS_MODULE,&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;.open&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;hello_open,&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;.<span class=\"hljs-built_in\" style=\"color: #e6c07b; line-height: 26px;\">read</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;hello_read,&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;.write&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;hello_write,&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;.poll&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;hello_poll,&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;.release&nbsp;&nbsp;&nbsp;=&nbsp;hello_close,&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;.unlocked_ioctl&nbsp;=&nbsp;hello_ioctl,<br>};<br><br>static&nbsp;__init&nbsp;int&nbsp;hello_init(void)&nbsp;<br>{<br>&nbsp;int&nbsp;err;<br>&nbsp;pr_info(<span class=\"hljs-string\" style=\"color: #98c379; line-height: 26px;\">\"hello&nbsp;driver&nbsp;init\\n\"</span>);<br>&nbsp;&nbsp;&nbsp;&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;/*&nbsp;动态分配字符设备:&nbsp;(major,0)&nbsp;*/<br>&nbsp;&nbsp;&nbsp;&nbsp;err&nbsp;=&nbsp;alloc_chrdev_region(&amp;devid,&nbsp;0,&nbsp;1,&nbsp;<span class=\"hljs-string\" style=\"color: #98c379; line-height: 26px;\">\"hello\"</span>);<br>&nbsp;<span class=\"hljs-keyword\" style=\"color: #c678dd; line-height: 26px;\">if</span>&nbsp;(err&nbsp;!=&nbsp;0)&nbsp;{<br>&nbsp;&nbsp;<span class=\"hljs-built_in\" style=\"color: #e6c07b; line-height: 26px;\">return</span>&nbsp;err;<br>&nbsp;}<br><br>&nbsp;&nbsp;&nbsp;&nbsp;cdev_init(&amp;hello_cdev,&nbsp;&amp;hello_fops);<br>&nbsp;&nbsp;&nbsp;&nbsp;cdev_add(&amp;hello_cdev,&nbsp;devid,&nbsp;1);<br>&nbsp;&nbsp;&nbsp;&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;/*&nbsp;创建类,它会在sys目录下创建/sys/class/hello这个类&nbsp;&nbsp;*/<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;hello_cls&nbsp;=&nbsp;class_create(THIS_MODULE,&nbsp;<span class=\"hljs-string\" style=\"color: #98c379; line-height: 26px;\">\"hello\"</span>);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class=\"hljs-keyword\" style=\"color: #c678dd; line-height: 26px;\">if</span>(IS_ERR(hello_cls)){<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;printk(<span class=\"hljs-string\" style=\"color: #98c379; line-height: 26px;\">\"can't&nbsp;create&nbsp;class\\n\"</span>);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class=\"hljs-built_in\" style=\"color: #e6c07b; line-height: 26px;\">return</span>&nbsp;ERROR;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>&nbsp;&nbsp;&nbsp;&nbsp;/*&nbsp;在/sys/class/hello下创建hello设备，然后mdev通过这个自动创建/dev/hello这个设备节点&nbsp;*/<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;device_create(hello_cls,&nbsp;NULL,&nbsp;devid,&nbsp;NULL,&nbsp;<span class=\"hljs-string\" style=\"color: #98c379; line-height: 26px;\">\"hello\"</span>);&nbsp;<br>&nbsp;<br>&nbsp;<span class=\"hljs-built_in\" style=\"color: #e6c07b; line-height: 26px;\">return</span>&nbsp;0;<br>}<br><br>static&nbsp;void&nbsp;__exit&nbsp;hello_exit(void)&nbsp;<br>{<br>&nbsp;&nbsp;&nbsp;&nbsp;pr_info(<span class=\"hljs-string\" style=\"color: #98c379; line-height: 26px;\">\"hello&nbsp;driver&nbsp;exit\\n\"</span>);<br>&nbsp;&nbsp;&nbsp;&nbsp;/*&nbsp;注销类、以及类设备&nbsp;/sys/class/hello会被移除*/<br>&nbsp;&nbsp;&nbsp;&nbsp;device_destroy(hello_cls,&nbsp;devid);<br>&nbsp;&nbsp;&nbsp;&nbsp;class_destroy(hello_cls);<br>&nbsp;&nbsp;&nbsp;&nbsp;<br>&nbsp;cdev_del(&amp;hello_cdev);<br>&nbsp;&nbsp;&nbsp;&nbsp;unregister_chrdev_region(devid,&nbsp;1);<br>}<br><br>module_init(hello_init);<br>module_exit(hello_exit);<br><br>MODULE_LICENSE(<span class=\"hljs-string\" style=\"color: #98c379; line-height: 26px;\">\"GPL\"</span>);<br><br></code></pre> \n<p data-tool=\"mdnice编辑器\" style=\"color: rgb(0, 0, 0); font-size: 16px; line-height: 1.8em; letter-spacing: 0em; text-align: left; text-indent: 0em; margin-top: 0px; margin-bottom: 0px; margin-left: 0px; margin-right: 0px; padding-top: 8px; padding-bottom: 8px; padding-left: 0px; padding-right: 0px;\">编译以上程序:</p> \n<pre class=\"custom\" data-tool=\"mdnice编辑器\" style=\"border-radius: 5px; box-shadow: rgba(0, 0, 0, 0.55) 0px 2px 10px; text-align: left; margin-top: 10px; margin-bottom: 10px; margin-left: 0px; margin-right: 0px; padding-top: 0px; padding-bottom: 0px; padding-left: 0px; padding-right: 0px;\"><span style=\"display: block; background: url(https://files.mdnice.com/user/3441/876cad08-0422-409d-bb5a-08afec5da8ee.svg); height: 30px; width: 100%; background-size: 40px; background-repeat: no-repeat; background-color: #282c34; margin-bottom: -7px; border-radius: 5px; background-position: 10px 10px;\"></span><code class=\"hljs\" style=\"overflow-x: auto; padding: 16px; color: #abb2bf; padding-top: 15px; background: #282c34; border-radius: 5px; display: -webkit-box; font-family: Consolas, Monaco, Menlo, monospace; font-size: 12px;\">aarch64-none-linux-gnu-gcc&nbsp;-o&nbsp;app&nbsp;app.c&nbsp;-lpthread<br><br></code></pre> \n<p data-tool=\"mdnice编辑器\" style=\"color: rgb(0, 0, 0); font-size: 16px; line-height: 1.8em; letter-spacing: 0em; text-align: left; text-indent: 0em; margin-top: 0px; margin-bottom: 0px; margin-left: 0px; margin-right: 0px; padding-top: 8px; padding-bottom: 8px; padding-left: 0px; padding-right: 0px;\">执行后的结果 <img src=\"https://files.mdnice.com/user/55303/7849c10c-451d-4c88-84e3-f80eb35bbdc0.png\" alt style=\"display: block; margin-top: 0px; margin-right: auto; margin-bottom: 0px; margin-left: auto; max-width: 100%;\"></p> \n<h2 data-tool=\"mdnice编辑器\" style=\"margin-top: 30px; margin-bottom: 15px; margin-left: 0px; margin-right: 0px; padding-top: 0px; padding-bottom: 0px; padding-left: 0px; padding-right: 0px; display: block;\"><span class=\"prefix\" style=\"display: none;\"></span><span class=\"content\" style=\"font-size: 22px; color: rgb(0, 0, 0); line-height: 1.5em; letter-spacing: 0em; text-align: left; font-weight: bold; display: block;\">总结</span><span class=\"suffix\" style=\"display: none;\"></span></h2> \n<p data-tool=\"mdnice编辑器\" style=\"color: rgb(0, 0, 0); font-size: 16px; line-height: 1.8em; letter-spacing: 0em; text-align: left; text-indent: 0em; margin-top: 0px; margin-bottom: 0px; margin-left: 0px; margin-right: 0px; padding-top: 8px; padding-bottom: 8px; padding-left: 0px; padding-right: 0px;\">本篇纯粹的个人看法总结，如有有疑问，可以评论区留言！互相学习,欢迎关注公众号[Linux随笔录]，不定期分享下Linux原创小知识</p> \n<p data-tool=\"mdnice编辑器\" style=\"color: rgb(0, 0, 0); font-size: 16px; line-height: 1.8em; letter-spacing: 0em; text-align: left; text-indent: 0em; margin-top: 0px; margin-bottom: 0px; margin-left: 0px; margin-right: 0px; padding-top: 8px; padding-bottom: 8px; padding-left: 0px; padding-right: 0px;\">参考博文：https://www.cnblogs.com/zyly/p/17810463.html#_label2_1</p>",
                "title": "Linux下completion机制学习",
                "categoryId": 1,
                "categoryName": "后端",
                "tagId": 100,
                "tagName": "后端",
                "userId": 55303,
                "userOutId": "875742422199",
                "username": "小勇",
                "avatar": "",
                "description": "什么是completioncompletion的函数介绍completion的函数使用总结什么是completionlinux内核中，完成量completion是一种代码同步机制。如果有一个或多个线程",
                "level": 1,
                "publishTime": "2024/08/24",
                "readingNum": 2,
                "likeNum": 0,
                "introduction": null,
                "followWords": null,
                "followPic": null,
                "isFollowing": false,
                "isLike": false,
                "isSelf": false,
                "type": 1,
                "isVisible": true,
                "invisibleReason": null,
                "writingColumn": {
                    "columnOutId": "4da138c7055e4fe7ace35d7a81ccfa02",
                    "name": "默认专栏",
                    "briefIntro": "这是一个默认专栏",
                    "cover": "https://files.mdnice.com/common/community/default-column-cover.jpg",
                    "writingNum": 33,
                    "createTime": "2024-08-06 19:03"
                }
            }
        },
        "__N_SSP": true
    },
    "page": "/writing/[id]",
    "query": {
        "id": "606b12bb6efe4e49b27e8919a55ec9b6"
    },
    "buildId": "ErZPkD4oq6iwH2nj6Dpcx",
    "isFallback": false,
    "gssp": true,
    "appGip": true
}