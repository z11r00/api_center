{
    "props": {
        "pageProps": {
            "query": {
                "id": "5fd5ae2a5c4b430cbff68b3407f34b41"
            },
            "ieBrowser": false,
            "needRefresh": false,
            "writingDetail": {
                "id": 86187,
                "outId": "5fd5ae2a5c4b430cbff68b3407f34b41",
                "articleOutId": "5fd5ae2a5c4b430cbff68b3407f34b41",
                "html": "<h2 data-tool=\"mdnice编辑器\" style=\"margin-top: 30px; margin-bottom: 15px; margin-left: 0px; margin-right: 0px; padding-top: 0px; padding-bottom: 0px; padding-left: 0px; padding-right: 0px; display: block;\"><span class=\"prefix\" style=\"display: none;\"></span><span class=\"content\" style=\"font-size: 22px; color: rgb(0, 0, 0); line-height: 1.5em; letter-spacing: 0em; text-align: left; font-weight: bold; display: block;\">手写一下正弦编码和旋转位置编码的代码？</span><span class=\"suffix\" style=\"display: none;\"></span></h2> \n<p data-tool=\"mdnice编辑器\" style=\"color: rgb(0, 0, 0); font-size: 16px; line-height: 1.8em; letter-spacing: 0em; text-align: left; text-indent: 0em; margin-top: 0px; margin-bottom: 0px; margin-left: 0px; margin-right: 0px; padding-top: 8px; padding-bottom: 8px; padding-left: 0px; padding-right: 0px;\">更多实时面试题总结请关注我的公众号\"算法狗\"</p> \n<p data-tool=\"mdnice编辑器\" style=\"color: rgb(0, 0, 0); font-size: 16px; line-height: 1.8em; letter-spacing: 0em; text-align: left; text-indent: 0em; margin-top: 0px; margin-bottom: 0px; margin-left: 0px; margin-right: 0px; padding-top: 8px; padding-bottom: 8px; padding-left: 0px; padding-right: 0px;\">面试中不太可能让写出整体的代码，只要写出核心代码就可以了。</p> \n<ul data-tool=\"mdnice编辑器\" style=\"list-style-type: disc; margin-top: 8px; margin-bottom: 8px; margin-left: 0px; margin-right: 0px; padding-top: 0px; padding-bottom: 0px; padding-left: 25px; padding-right: 0px; color: rgb(0, 0, 0);\"> \n <li> \n  <section style=\"margin-top: 5px; margin-bottom: 5px; color: rgb(1, 1, 1); font-size: 16px; line-height: 1.8em; letter-spacing: 0em; text-align: left; font-weight: normal;\">\n    正弦位置编码 \n  </section></li> \n</ul> \n<pre class=\"custom\" data-tool=\"mdnice编辑器\" style=\"border-radius: 5px; box-shadow: rgba(0, 0, 0, 0.55) 0px 2px 10px; text-align: left; margin-top: 10px; margin-bottom: 10px; margin-left: 0px; margin-right: 0px; padding-top: 0px; padding-bottom: 0px; padding-left: 0px; padding-right: 0px;\"><span style=\"display: block; background: url(https://files.mdnice.com/user/3441/876cad08-0422-409d-bb5a-08afec5da8ee.svg); height: 30px; width: 100%; background-size: 40px; background-repeat: no-repeat; background-color: #282c34; margin-bottom: -7px; border-radius: 5px; background-position: 10px 10px;\"></span><code class=\"hljs\" style=\"overflow-x: auto; padding: 16px; color: #abb2bf; padding-top: 15px; background: #282c34; border-radius: 5px; display: -webkit-box; font-family: Consolas, Monaco, Menlo, monospace; font-size: 12px;\">position&nbsp;=&nbsp;torch.arange(<span class=\"hljs-number\" style=\"color: #d19a66; line-height: 26px;\">0</span>,&nbsp;max_len,&nbsp;dtype=torch.float32).unsqueeze(<span class=\"hljs-number\" style=\"color: #d19a66; line-height: 26px;\">1</span>)<br>two_i&nbsp;=&nbsp;torch.arange(<span class=\"hljs-number\" style=\"color: #d19a66; line-height: 26px;\">0</span>,&nbsp;d_model,&nbsp;<span class=\"hljs-number\" style=\"color: #d19a66; line-height: 26px;\">2</span>,&nbsp;dtype=torch.float32)<br>div_term&nbsp;=&nbsp;torch.exp(two_i&nbsp;*&nbsp;-(math.log(<span class=\"hljs-number\" style=\"color: #d19a66; line-height: 26px;\">10000.0</span>)&nbsp;/&nbsp;d_model))<br>encodings&nbsp;=&nbsp;torch.zeros(max_len,&nbsp;d_model)<br>encodings[:,&nbsp;<span class=\"hljs-number\" style=\"color: #d19a66; line-height: 26px;\">0</span>::<span class=\"hljs-number\" style=\"color: #d19a66; line-height: 26px;\">2</span>]&nbsp;=&nbsp;torch.sin(position&nbsp;*&nbsp;div_term)<br>encodings[:,&nbsp;<span class=\"hljs-number\" style=\"color: #d19a66; line-height: 26px;\">1</span>::<span class=\"hljs-number\" style=\"color: #d19a66; line-height: 26px;\">2</span>]&nbsp;=&nbsp;torch.cos(position&nbsp;*&nbsp;div_term)<br></code></pre> \n<p data-tool=\"mdnice编辑器\" style=\"color: rgb(0, 0, 0); font-size: 16px; line-height: 1.8em; letter-spacing: 0em; text-align: left; text-indent: 0em; margin-top: 0px; margin-bottom: 0px; margin-left: 0px; margin-right: 0px; padding-top: 8px; padding-bottom: 8px; padding-left: 0px; padding-right: 0px;\">上述代码中的一些变量的含义这里就不作介绍了，懂得都懂。</p> \n<ul data-tool=\"mdnice编辑器\" style=\"list-style-type: disc; margin-top: 8px; margin-bottom: 8px; margin-left: 0px; margin-right: 0px; padding-top: 0px; padding-bottom: 0px; padding-left: 25px; padding-right: 0px; color: rgb(0, 0, 0);\"> \n <li> \n  <section style=\"margin-top: 5px; margin-bottom: 5px; color: rgb(1, 1, 1); font-size: 16px; line-height: 1.8em; letter-spacing: 0em; text-align: left; font-weight: normal;\">\n    旋转位置编码 \n   <br> 这个部分比较复杂一些，其中重要的逻辑是在计算旋转变换矩阵那里，中间设计到复数域的变化，比较麻烦，建议调试一下代码看下整体的逻辑： \n  </section></li> \n</ul> \n<pre class=\"custom\" data-tool=\"mdnice编辑器\" style=\"border-radius: 5px; box-shadow: rgba(0, 0, 0, 0.55) 0px 2px 10px; text-align: left; margin-top: 10px; margin-bottom: 10px; margin-left: 0px; margin-right: 0px; padding-top: 0px; padding-bottom: 0px; padding-left: 0px; padding-right: 0px;\"><span style=\"display: block; background: url(https://files.mdnice.com/user/3441/876cad08-0422-409d-bb5a-08afec5da8ee.svg); height: 30px; width: 100%; background-size: 40px; background-repeat: no-repeat; background-color: #282c34; margin-bottom: -7px; border-radius: 5px; background-position: 10px 10px;\"></span><code class=\"hljs\" style=\"overflow-x: auto; padding: 16px; color: #abb2bf; padding-top: 15px; background: #282c34; border-radius: 5px; display: -webkit-box; font-family: Consolas, Monaco, Menlo, monospace; font-size: 12px;\"><span class=\"hljs-comment\" style=\"color: #5c6370; font-style: italic; line-height: 26px;\">#&nbsp;生成旋转矩阵</span><br><span class=\"hljs-function\" style=\"line-height: 26px;\"><span class=\"hljs-keyword\" style=\"color: #c678dd; line-height: 26px;\">def</span>&nbsp;<span class=\"hljs-title\" style=\"color: #61aeee; line-height: 26px;\">precompute_freqs_cis</span><span class=\"hljs-params\" style=\"line-height: 26px;\">(dim:&nbsp;int,&nbsp;seq_len:&nbsp;int,&nbsp;theta:&nbsp;float&nbsp;=&nbsp;<span class=\"hljs-number\" style=\"color: #d19a66; line-height: 26px;\">10000.0</span>)</span>:</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class=\"hljs-comment\" style=\"color: #5c6370; font-style: italic; line-height: 26px;\">#&nbsp;计算词向量元素两两分组之后，每组元素对应的旋转角度\\theta_i</span><br>&nbsp;&nbsp;&nbsp;&nbsp;freqs&nbsp;=&nbsp;<span class=\"hljs-number\" style=\"color: #d19a66; line-height: 26px;\">1.0</span>&nbsp;/&nbsp;(theta&nbsp;**&nbsp;(torch.arange(<span class=\"hljs-number\" style=\"color: #d19a66; line-height: 26px;\">0</span>,&nbsp;dim,&nbsp;<span class=\"hljs-number\" style=\"color: #d19a66; line-height: 26px;\">2</span>)[:&nbsp;(dim&nbsp;//&nbsp;<span class=\"hljs-number\" style=\"color: #d19a66; line-height: 26px;\">2</span>)].float()&nbsp;/&nbsp;dim))<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class=\"hljs-comment\" style=\"color: #5c6370; font-style: italic; line-height: 26px;\">#&nbsp;生成&nbsp;token&nbsp;序列索引&nbsp;t&nbsp;=&nbsp;[0,&nbsp;1,...,&nbsp;seq_len-1]</span><br>&nbsp;&nbsp;&nbsp;&nbsp;t&nbsp;=&nbsp;torch.arange(seq_len,&nbsp;device=freqs.device)<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class=\"hljs-comment\" style=\"color: #5c6370; font-style: italic; line-height: 26px;\">#&nbsp;freqs.shape&nbsp;=&nbsp;[seq_len,&nbsp;dim&nbsp;//&nbsp;2]&nbsp;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;freqs&nbsp;=&nbsp;torch.outer(t,&nbsp;freqs).float()&nbsp;&nbsp;<span class=\"hljs-comment\" style=\"color: #5c6370; font-style: italic; line-height: 26px;\">#&nbsp;计算m&nbsp;*&nbsp;\\theta</span><br><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class=\"hljs-comment\" style=\"color: #5c6370; font-style: italic; line-height: 26px;\">#&nbsp;计算结果是个复数向量</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class=\"hljs-comment\" style=\"color: #5c6370; font-style: italic; line-height: 26px;\">#&nbsp;假设&nbsp;freqs&nbsp;=&nbsp;[x,&nbsp;y]</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class=\"hljs-comment\" style=\"color: #5c6370; font-style: italic; line-height: 26px;\">#&nbsp;则&nbsp;freqs_cis&nbsp;=&nbsp;[cos(x)&nbsp;+&nbsp;sin(x)i,&nbsp;cos(y)&nbsp;+&nbsp;sin(y)i]</span><br>&nbsp;&nbsp;&nbsp;&nbsp;freqs_cis&nbsp;=&nbsp;torch.polar(torch.ones_like(freqs),&nbsp;freqs)&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class=\"hljs-keyword\" style=\"color: #c678dd; line-height: 26px;\">return</span>&nbsp;freqs_cis<br><br><span class=\"hljs-comment\" style=\"color: #5c6370; font-style: italic; line-height: 26px;\">#&nbsp;旋转位置编码计算</span><br><span class=\"hljs-function\" style=\"line-height: 26px;\"><span class=\"hljs-keyword\" style=\"color: #c678dd; line-height: 26px;\">def</span>&nbsp;<span class=\"hljs-title\" style=\"color: #61aeee; line-height: 26px;\">apply_rotary_emb</span><span class=\"hljs-params\" style=\"line-height: 26px;\">(<br>&nbsp;&nbsp;&nbsp;&nbsp;xq:&nbsp;torch.Tensor,<br>&nbsp;&nbsp;&nbsp;&nbsp;xk:&nbsp;torch.Tensor,<br>&nbsp;&nbsp;&nbsp;&nbsp;freqs_cis:&nbsp;torch.Tensor,<br>)</span>&nbsp;-&gt;&nbsp;Tuple[torch.Tensor,&nbsp;torch.Tensor]:</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class=\"hljs-comment\" style=\"color: #5c6370; font-style: italic; line-height: 26px;\">#&nbsp;xq.shape&nbsp;=&nbsp;[batch_size,&nbsp;seq_len,&nbsp;dim]</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class=\"hljs-comment\" style=\"color: #5c6370; font-style: italic; line-height: 26px;\">#&nbsp;xq_.shape&nbsp;=&nbsp;[batch_size,&nbsp;seq_len,&nbsp;dim&nbsp;//&nbsp;2,&nbsp;2]</span><br>&nbsp;&nbsp;&nbsp;&nbsp;xq_&nbsp;=&nbsp;xq.float().reshape(*xq.shape[:<span class=\"hljs-number\" style=\"color: #d19a66; line-height: 26px;\">-1</span>],&nbsp;<span class=\"hljs-number\" style=\"color: #d19a66; line-height: 26px;\">-1</span>,&nbsp;<span class=\"hljs-number\" style=\"color: #d19a66; line-height: 26px;\">2</span>)<br>&nbsp;&nbsp;&nbsp;&nbsp;xk_&nbsp;=&nbsp;xk.float().reshape(*xk.shape[:<span class=\"hljs-number\" style=\"color: #d19a66; line-height: 26px;\">-1</span>],&nbsp;<span class=\"hljs-number\" style=\"color: #d19a66; line-height: 26px;\">-1</span>,&nbsp;<span class=\"hljs-number\" style=\"color: #d19a66; line-height: 26px;\">2</span>)<br>&nbsp;&nbsp;&nbsp;&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class=\"hljs-comment\" style=\"color: #5c6370; font-style: italic; line-height: 26px;\">#&nbsp;转为复数域</span><br>&nbsp;&nbsp;&nbsp;&nbsp;xq_&nbsp;=&nbsp;torch.view_as_complex(xq_)<br>&nbsp;&nbsp;&nbsp;&nbsp;xk_&nbsp;=&nbsp;torch.view_as_complex(xk_)<br>&nbsp;&nbsp;&nbsp;&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class=\"hljs-comment\" style=\"color: #5c6370; font-style: italic; line-height: 26px;\">#&nbsp;应用旋转操作，然后将结果转回实数域</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class=\"hljs-comment\" style=\"color: #5c6370; font-style: italic; line-height: 26px;\">#&nbsp;xq_out.shape&nbsp;=&nbsp;[batch_size,&nbsp;seq_len,&nbsp;dim]</span><br>&nbsp;&nbsp;&nbsp;&nbsp;xq_out&nbsp;=&nbsp;torch.view_as_real(xq_&nbsp;*&nbsp;freqs_cis).flatten(<span class=\"hljs-number\" style=\"color: #d19a66; line-height: 26px;\">2</span>)<br>&nbsp;&nbsp;&nbsp;&nbsp;xk_out&nbsp;=&nbsp;torch.view_as_real(xk_&nbsp;*&nbsp;freqs_cis).flatten(<span class=\"hljs-number\" style=\"color: #d19a66; line-height: 26px;\">2</span>)<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class=\"hljs-keyword\" style=\"color: #c678dd; line-height: 26px;\">return</span>&nbsp;xq_out.type_as(xq),&nbsp;xk_out.type_as(xk)<br><br><span class=\"hljs-class\" style=\"line-height: 26px;\"><span class=\"hljs-keyword\" style=\"color: #c678dd; line-height: 26px;\">class</span>&nbsp;<span class=\"hljs-title\" style=\"color: #e6c07b; line-height: 26px;\">Attention</span><span class=\"hljs-params\" style=\"line-height: 26px;\">(nn.Module)</span>:</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class=\"hljs-function\" style=\"line-height: 26px;\"><span class=\"hljs-keyword\" style=\"color: #c678dd; line-height: 26px;\">def</span>&nbsp;<span class=\"hljs-title\" style=\"color: #61aeee; line-height: 26px;\">__init__</span><span class=\"hljs-params\" style=\"line-height: 26px;\">(self,&nbsp;args:&nbsp;ModelArgs)</span>:</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;super().__init__()<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self.wq&nbsp;=&nbsp;Linear(...)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self.wk&nbsp;=&nbsp;Linear(...)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self.wv&nbsp;=&nbsp;Linear(...)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self.freqs_cis&nbsp;=&nbsp;precompute_freqs_cis(dim,&nbsp;max_seq_len&nbsp;*&nbsp;<span class=\"hljs-number\" style=\"color: #d19a66; line-height: 26px;\">2</span>)<br><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class=\"hljs-function\" style=\"line-height: 26px;\"><span class=\"hljs-keyword\" style=\"color: #c678dd; line-height: 26px;\">def</span>&nbsp;<span class=\"hljs-title\" style=\"color: #61aeee; line-height: 26px;\">forward</span><span class=\"hljs-params\" style=\"line-height: 26px;\">(self,&nbsp;x:&nbsp;torch.Tensor)</span>:</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;bsz,&nbsp;seqlen,&nbsp;_&nbsp;=&nbsp;x.shape<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;xq,&nbsp;xk,&nbsp;xv&nbsp;=&nbsp;self.wq(x),&nbsp;self.wk(x),&nbsp;self.wv(x)<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;xq&nbsp;=&nbsp;xq.view(batch_size,&nbsp;seq_len,&nbsp;dim)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;xk&nbsp;=&nbsp;xk.view(batch_size,&nbsp;seq_len,&nbsp;dim)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;xv&nbsp;=&nbsp;xv.view(batch_size,&nbsp;seq_len,&nbsp;dim)<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class=\"hljs-comment\" style=\"color: #5c6370; font-style: italic; line-height: 26px;\">#&nbsp;attention&nbsp;操作之前，应用旋转位置编码</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;xq,&nbsp;xk&nbsp;=&nbsp;apply_rotary_emb(xq,&nbsp;xk,&nbsp;freqs_cis=freqs_cis)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class=\"hljs-comment\" style=\"color: #5c6370; font-style: italic; line-height: 26px;\">#&nbsp;scores.shape&nbsp;=&nbsp;(bs,&nbsp;seqlen,&nbsp;seqlen)</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;scores&nbsp;=&nbsp;torch.matmul(xq,&nbsp;xk.transpose(<span class=\"hljs-number\" style=\"color: #d19a66; line-height: 26px;\">1</span>,&nbsp;<span class=\"hljs-number\" style=\"color: #d19a66; line-height: 26px;\">2</span>))&nbsp;/&nbsp;math.sqrt(dim)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;scores&nbsp;=&nbsp;F.softmax(scores.float(),&nbsp;dim=<span class=\"hljs-number\" style=\"color: #d19a66; line-height: 26px;\">-1</span>)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;output&nbsp;=&nbsp;torch.matmul(scores,&nbsp;xv)&nbsp;&nbsp;<span class=\"hljs-comment\" style=\"color: #5c6370; font-style: italic; line-height: 26px;\">#&nbsp;(batch_size,&nbsp;seq_len,&nbsp;dim)</span><br>&nbsp;&nbsp;<span class=\"hljs-comment\" style=\"color: #5c6370; font-style: italic; line-height: 26px;\">#&nbsp;......</span><br></code></pre> \n<p data-tool=\"mdnice编辑器\" style=\"color: rgb(0, 0, 0); font-size: 16px; line-height: 1.8em; letter-spacing: 0em; text-align: left; text-indent: 0em; margin-top: 0px; margin-bottom: 0px; margin-left: 0px; margin-right: 0px; padding-top: 8px; padding-bottom: 8px; padding-left: 0px; padding-right: 0px;\">参考：<br> [1] https://zhuanlan.zhihu.com/p/689205140<br> [2] https://zhuanlan.zhihu.com/p/647109286</p>",
                "title": "2024-11-6",
                "categoryId": 1,
                "categoryName": "后端",
                "tagId": 100,
                "tagName": "后端",
                "userId": 28978,
                "userOutId": "220287652781",
                "username": "alexalt",
                "avatar": "",
                "description": "手写一下正弦编码和旋转位置编码的代码？更多实时面试题总结请关注我的公众号\"算法狗\"面试中不太可能让写出整体的代码，只要写出核心代码就可以了。正弦位置编码position&nbsp;=&nbsp;tor",
                "level": 1,
                "publishTime": "2024/11/06",
                "readingNum": 4,
                "likeNum": 0,
                "introduction": null,
                "followWords": null,
                "followPic": null,
                "isFollowing": false,
                "isLike": false,
                "isSelf": false,
                "type": 1,
                "isVisible": true,
                "invisibleReason": null,
                "writingColumn": {
                    "columnOutId": "1d96a1dd442f4d2e8d87540ae4363268",
                    "name": "默认专栏",
                    "briefIntro": "这是一个默认专栏",
                    "cover": "https://files.mdnice.com/common/community/default-column-cover.jpg",
                    "writingNum": 6,
                    "createTime": "2024-08-06 19:05"
                }
            }
        },
        "__N_SSP": true
    },
    "page": "/writing/[id]",
    "query": {
        "id": "5fd5ae2a5c4b430cbff68b3407f34b41"
    },
    "buildId": "ErZPkD4oq6iwH2nj6Dpcx",
    "isFallback": false,
    "gssp": true,
    "appGip": true
}