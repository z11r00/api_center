{
    "props": {
        "pageProps": {
            "query": {
                "id": "ca71dd61044d4f51a309aaebe68e5130"
            },
            "ieBrowser": false,
            "needRefresh": false,
            "writingDetail": {
                "id": 84685,
                "outId": "ca71dd61044d4f51a309aaebe68e5130",
                "articleOutId": "ca71dd61044d4f51a309aaebe68e5130",
                "html": "<h2 data-tool=\"mdnice编辑器\" style=\"margin-top: 30px; margin-bottom: 15px; margin-left: 0px; margin-right: 0px; padding-top: 0px; padding-bottom: 0px; padding-left: 0px; padding-right: 0px; display: block;\"><span class=\"prefix\" style=\"display: none;\"></span><span class=\"content\" style=\"font-size: 22px; color: rgb(0, 0, 0); line-height: 1.5em; letter-spacing: 0em; text-align: left; font-weight: bold; display: block;\">背景</span><span class=\"suffix\" style=\"display: none;\"></span></h2> \n<figure data-tool=\"mdnice编辑器\" style=\"margin-top: 10px; margin-bottom: 10px; margin-left: 0px; margin-right: 0px; padding-top: 0px; padding-bottom: 0px; padding-left: 0px; padding-right: 0px; display: flex; flex-direction: column; justify-content: center; align-items: center;\"> \n <img src=\"https://files.mdnice.com/user/63514/399f6197-e473-4c02-a3f4-6bb6a5dad0b8.png\" alt style=\"display: block; margin-top: 0px; margin-right: auto; margin-bottom: 0px; margin-left: auto; max-width: 100%; border-top-style: none; border-bottom-style: none; border-left-style: none; border-right-style: none; border-top-width: 3px; border-bottom-width: 3px; border-left-width: 3px; border-right-width: 3px; border-top-color: rgba(0, 0, 0, 0.4); border-bottom-color: rgba(0, 0, 0, 0.4); border-left-color: rgba(0, 0, 0, 0.4); border-right-color: rgba(0, 0, 0, 0.4); border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; object-fit: fill; box-shadow: rgba(0, 0, 0, 0) 0px 0px 0px 0px;\"> \n</figure> \n<figure data-tool=\"mdnice编辑器\" style=\"margin-top: 10px; margin-bottom: 10px; margin-left: 0px; margin-right: 0px; padding-top: 0px; padding-bottom: 0px; padding-left: 0px; padding-right: 0px; display: flex; flex-direction: column; justify-content: center; align-items: center;\"> \n <img src=\"https://files.mdnice.com/user/63514/a8fee94f-9240-4bf0-9fc2-888c77347669.png\" alt style=\"display: block; margin-top: 0px; margin-right: auto; margin-bottom: 0px; margin-left: auto; max-width: 100%; border-top-style: none; border-bottom-style: none; border-left-style: none; border-right-style: none; border-top-width: 3px; border-bottom-width: 3px; border-left-width: 3px; border-right-width: 3px; border-top-color: rgba(0, 0, 0, 0.4); border-bottom-color: rgba(0, 0, 0, 0.4); border-left-color: rgba(0, 0, 0, 0.4); border-right-color: rgba(0, 0, 0, 0.4); border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; object-fit: fill; box-shadow: rgba(0, 0, 0, 0) 0px 0px 0px 0px;\"> \n</figure> \n<blockquote class=\"multiquote-1\" data-tool=\"mdnice编辑器\" style=\"margin-top: 20px; margin-bottom: 20px; margin-left: 0px; margin-right: 0px; padding-top: 10px; padding-bottom: 10px; padding-left: 20px; padding-right: 10px; border-top-style: none; border-bottom-style: none; border-left-style: solid; border-right-style: none; border-top-width: 3px; border-bottom-width: 3px; border-left-width: 3px; border-right-width: 3px; border-top-color: rgba(0, 0, 0, 0.4); border-bottom-color: rgba(0, 0, 0, 0.4); border-left-color: rgba(0, 0, 0, 0.4); border-right-color: rgba(0, 0, 0, 0.4); border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; background-attachment: scroll; background-clip: border-box; background-color: rgba(0, 0, 0, 0.05); background-image: none; background-origin: padding-box; background-position-x: 0%; background-position-y: 0%; background-repeat: no-repeat; background-size: auto; width: auto; height: auto; box-shadow: rgba(0, 0, 0, 0) 0px 0px 0px 0px; display: block; overflow-x: auto; overflow-y: auto;\"> <span style=\"display: none; color: rgb(0, 0, 0); font-size: 16px; line-height: 1.5em; letter-spacing: 0em; text-align: left; font-weight: normal;\"></span> \n <p style=\"text-indent: 0em; padding-top: 8px; padding-bottom: 8px; padding-left: 0px; padding-right: 0px; color: rgb(0, 0, 0); font-size: 16px; line-height: 1.8em; letter-spacing: 0em; text-align: left; font-weight: normal; margin-top: 0px; margin-right: 0px; margin-bottom: 0px; margin-left: 0px;\">DBA同事在钉钉发了两张截图，作为“始作俑者”的我很心虚，因为刚才是我在管理后台查询数据，结果很久都没出来，并且用多个维度查了N次</p> \n</blockquote> \n<h2 data-tool=\"mdnice编辑器\" style=\"margin-top: 30px; margin-bottom: 15px; margin-left: 0px; margin-right: 0px; padding-top: 0px; padding-bottom: 0px; padding-left: 0px; padding-right: 0px; display: block;\"><span class=\"prefix\" style=\"display: none;\"></span><span class=\"content\" style=\"font-size: 22px; color: rgb(0, 0, 0); line-height: 1.5em; letter-spacing: 0em; text-align: left; font-weight: bold; display: block;\">问题分析</span><span class=\"suffix\" style=\"display: none;\"></span></h2> \n<p data-tool=\"mdnice编辑器\" style=\"color: rgb(0, 0, 0); font-size: 16px; line-height: 1.8em; letter-spacing: 0em; text-align: left; text-indent: 0em; margin-top: 0px; margin-bottom: 0px; margin-left: 0px; margin-right: 0px; padding-top: 8px; padding-bottom: 8px; padding-left: 0px; padding-right: 0px;\">这是当天上线的功能，完事我立马锁定SQL然后开启排查</p> \n<pre class=\"custom\" data-tool=\"mdnice编辑器\" style=\"border-radius: 5px; box-shadow: rgba(0, 0, 0, 0.55) 0px 2px 10px; text-align: left; margin-top: 10px; margin-bottom: 10px; margin-left: 0px; margin-right: 0px; padding-top: 0px; padding-bottom: 0px; padding-left: 0px; padding-right: 0px;\"><span style=\"display: block; background: url(https://files.mdnice.com/user/3441/876cad08-0422-409d-bb5a-08afec5da8ee.svg); height: 30px; width: 100%; background-size: 40px; background-repeat: no-repeat; background-color: #282c34; margin-bottom: -7px; border-radius: 5px; background-position: 10px 10px;\"></span><code class=\"hljs\" style=\"overflow-x: auto; padding: 16px; color: #abb2bf; padding-top: 15px; background: #282c34; border-radius: 5px; display: -webkit-box; font-family: Consolas, Monaco, Menlo, monospace; font-size: 12px;\"><span class=\"hljs-comment\" style=\"color: #5c6370; font-style: italic; line-height: 26px;\">#&nbsp;原SQL，此为分页接口中count部分</span><br>SELECT<br>&nbsp;COUNT(&nbsp;1&nbsp;)&nbsp;<br>FROM<br>&nbsp;shop_day_statistics&nbsp;a<br>&nbsp;LEFT&nbsp;JOIN&nbsp;(<br>&nbsp;SELECT<br>&nbsp;&nbsp;shop_id&nbsp;shop_id,<br>&nbsp;&nbsp;statistics_time,<br>&nbsp;&nbsp;merchant_id,<br>&nbsp;&nbsp;GROUP_CONCAT(&nbsp;CONCAT_ws(&nbsp;<span class=\"hljs-string\" style=\"color: #98c379; line-height: 26px;\">'-'</span>,&nbsp;service_id,&nbsp;service_name&nbsp;)&nbsp;SEPARATOR&nbsp;<span class=\"hljs-string\" style=\"color: #98c379; line-height: 26px;\">','</span>&nbsp;)&nbsp;AS&nbsp;service_name,<br>&nbsp;&nbsp;sum(&nbsp;profit_amount&nbsp;)&nbsp;profit_amount&nbsp;<br>&nbsp;FROM<br>&nbsp;&nbsp;service_day_statistics&nbsp;<br>&nbsp;GROUP&nbsp;BY<br>&nbsp;&nbsp;shop_id,<br>&nbsp;&nbsp;statistics_time&nbsp;<br>&nbsp;)&nbsp;s&nbsp;ON&nbsp;s.shop_id&nbsp;=&nbsp;a.shop_id<br>&nbsp;<br>&nbsp;AND&nbsp;a.statistics_time&nbsp;=&nbsp;s.statistics_time&nbsp;<br>WHERE<br>&nbsp;a.statistics_time&nbsp;BETWEEN&nbsp;<span class=\"hljs-string\" style=\"color: #98c379; line-height: 26px;\">'2023-09-05&nbsp;00:00:00.0'</span>&nbsp;<br>&nbsp;AND&nbsp;<span class=\"hljs-string\" style=\"color: #98c379; line-height: 26px;\">'2024-10-22&nbsp;00:00:00.0'</span>&nbsp;<br>&nbsp;AND&nbsp;a.shop_id&nbsp;=&nbsp;999999;<br>&nbsp;&nbsp;&nbsp;&nbsp;<br><span class=\"hljs-comment\" style=\"color: #5c6370; font-style: italic; line-height: 26px;\">#&nbsp;SQL解释</span><br>此SQL中有两张表：shop_day_statistics(5800W)、service_day_statistics(30多万)<br>下面将用A表来替代shop_day_statistics，B表来替代service_day_statistics<br>A表与B表的关系是一对多，因业务的需要，故之前在一条SQL上查询得出<br><br>表结构：<br>DROP&nbsp;TABLE&nbsp;IF&nbsp;EXISTS&nbsp;`shop_day_statistics`;<br>CREATE&nbsp;TABLE&nbsp;`shop_day_statistics`&nbsp;&nbsp;(<br>&nbsp;&nbsp;`id`&nbsp;bigint&nbsp;NOT&nbsp;NULL&nbsp;AUTO_INCREMENT&nbsp;COMMENT&nbsp;<span class=\"hljs-string\" style=\"color: #98c379; line-height: 26px;\">'id'</span>,<br>&nbsp;&nbsp;`statistics_time`&nbsp;date&nbsp;NOT&nbsp;NULL&nbsp;COMMENT&nbsp;<span class=\"hljs-string\" style=\"color: #98c379; line-height: 26px;\">'统计日期'</span>,<br>&nbsp;&nbsp;`group_id`&nbsp;bigint&nbsp;NULL&nbsp;DEFAULT&nbsp;NULL&nbsp;COMMENT&nbsp;<span class=\"hljs-string\" style=\"color: #98c379; line-height: 26px;\">'代理商ID'</span>,<br>&nbsp;&nbsp;`group_name`&nbsp;varchar(70)&nbsp;CHARACTER&nbsp;SET&nbsp;utf8mb4&nbsp;COLLATE&nbsp;utf8mb4_0900_ai_ci&nbsp;NULL&nbsp;DEFAULT&nbsp;NULL&nbsp;COMMENT&nbsp;<span class=\"hljs-string\" style=\"color: #98c379; line-height: 26px;\">'代理商名称'</span>,<br>&nbsp;&nbsp;`shop_id`&nbsp;bigint&nbsp;NULL&nbsp;DEFAULT&nbsp;NULL&nbsp;COMMENT&nbsp;<span class=\"hljs-string\" style=\"color: #98c379; line-height: 26px;\">'门店ID'</span>,<br>&nbsp;&nbsp;`shop_name`&nbsp;varchar(200)&nbsp;CHARACTER&nbsp;SET&nbsp;utf8mb4&nbsp;COLLATE&nbsp;utf8mb4_0900_ai_ci&nbsp;NULL&nbsp;DEFAULT&nbsp;NULL&nbsp;COMMENT&nbsp;<span class=\"hljs-string\" style=\"color: #98c379; line-height: 26px;\">'门店名称'</span>,<br>&nbsp;&nbsp;`merchant_id`&nbsp;bigint&nbsp;NULL&nbsp;DEFAULT&nbsp;NULL&nbsp;COMMENT&nbsp;<span class=\"hljs-string\" style=\"color: #98c379; line-height: 26px;\">'商户ID'</span>,<br>&nbsp;&nbsp;`merchant_name`&nbsp;varchar(200)&nbsp;CHARACTER&nbsp;SET&nbsp;utf8mb4&nbsp;COLLATE&nbsp;utf8mb4_0900_ai_ci&nbsp;NULL&nbsp;DEFAULT&nbsp;NULL&nbsp;COMMENT&nbsp;<span class=\"hljs-string\" style=\"color: #98c379; line-height: 26px;\">'商户名称'</span>,<br>&nbsp;&nbsp;`employee_id`&nbsp;bigint&nbsp;NULL&nbsp;DEFAULT&nbsp;NULL&nbsp;COMMENT&nbsp;<span class=\"hljs-string\" style=\"color: #98c379; line-height: 26px;\">'员工ID'</span>,<br>&nbsp;&nbsp;`employee_name`&nbsp;varchar(45)&nbsp;CHARACTER&nbsp;SET&nbsp;utf8mb4&nbsp;COLLATE&nbsp;utf8mb4_0900_ai_ci&nbsp;NULL&nbsp;DEFAULT&nbsp;NULL&nbsp;COMMENT&nbsp;<span class=\"hljs-string\" style=\"color: #98c379; line-height: 26px;\">'员工名称'</span>,<br>&nbsp;&nbsp;PRIMARY&nbsp;KEY&nbsp;(`id`)&nbsp;USING&nbsp;BTREE,<br>&nbsp;&nbsp;INDEX&nbsp;`idx_groupid_time`(`group_id`&nbsp;ASC,&nbsp;`statistics_time`&nbsp;ASC)&nbsp;USING&nbsp;BTREE,<br>&nbsp;&nbsp;INDEX&nbsp;`idx_merchantid_time`(`merchant_id`&nbsp;ASC,&nbsp;`statistics_time`&nbsp;ASC)&nbsp;USING&nbsp;BTREE,<br>&nbsp;&nbsp;INDEX&nbsp;`idx_statistics_time`(`statistics_time`&nbsp;ASC)&nbsp;USING&nbsp;BTREE<br>)&nbsp;ENGINE&nbsp;=&nbsp;InnoDB&nbsp;AUTO_INCREMENT&nbsp;=&nbsp;1&nbsp;CHARACTER&nbsp;SET&nbsp;=&nbsp;utf8mb4&nbsp;COLLATE&nbsp;=&nbsp;utf8mb4_0900_ai_ci&nbsp;COMMENT&nbsp;=&nbsp;<span class=\"hljs-string\" style=\"color: #98c379; line-height: 26px;\">'门店日收益统计'</span>&nbsp;ROW_FORMAT&nbsp;=&nbsp;DYNAMIC;<br><br>DROP&nbsp;TABLE&nbsp;IF&nbsp;EXISTS&nbsp;`service_day_statistics`;<br>CREATE&nbsp;TABLE&nbsp;`service_day_statistics`&nbsp;&nbsp;(<br>&nbsp;&nbsp;`id`&nbsp;bigint&nbsp;NOT&nbsp;NULL&nbsp;AUTO_INCREMENT&nbsp;COMMENT&nbsp;<span class=\"hljs-string\" style=\"color: #98c379; line-height: 26px;\">'id'</span>,<br>&nbsp;&nbsp;`statistics_time`&nbsp;date&nbsp;NOT&nbsp;NULL&nbsp;COMMENT&nbsp;<span class=\"hljs-string\" style=\"color: #98c379; line-height: 26px;\">'统计日期'</span>,<br>&nbsp;&nbsp;`shop_id`&nbsp;bigint&nbsp;NULL&nbsp;DEFAULT&nbsp;NULL&nbsp;COMMENT&nbsp;<span class=\"hljs-string\" style=\"color: #98c379; line-height: 26px;\">'门店ID'</span>,<br>&nbsp;&nbsp;`shop_name`&nbsp;varchar(200)&nbsp;CHARACTER&nbsp;SET&nbsp;utf8mb4&nbsp;COLLATE&nbsp;utf8mb4_0900_ai_ci&nbsp;NULL&nbsp;DEFAULT&nbsp;NULL&nbsp;COMMENT&nbsp;<span class=\"hljs-string\" style=\"color: #98c379; line-height: 26px;\">'门店名称'</span>,<br>&nbsp;&nbsp;`merchant_id`&nbsp;bigint&nbsp;NULL&nbsp;DEFAULT&nbsp;NULL&nbsp;COMMENT&nbsp;<span class=\"hljs-string\" style=\"color: #98c379; line-height: 26px;\">'商户ID'</span>,<br>&nbsp;&nbsp;`merchant_name`&nbsp;varchar(200)&nbsp;CHARACTER&nbsp;SET&nbsp;utf8mb4&nbsp;COLLATE&nbsp;utf8mb4_0900_ai_ci&nbsp;NULL&nbsp;DEFAULT&nbsp;NULL&nbsp;COMMENT&nbsp;<span class=\"hljs-string\" style=\"color: #98c379; line-height: 26px;\">'商户名称'</span>,<br>&nbsp;&nbsp;`service_id`&nbsp;bigint&nbsp;NULL&nbsp;DEFAULT&nbsp;NULL&nbsp;COMMENT&nbsp;<span class=\"hljs-string\" style=\"color: #98c379; line-height: 26px;\">'服务商id'</span>,<br>&nbsp;&nbsp;`service_name`&nbsp;varchar(45)&nbsp;CHARACTER&nbsp;SET&nbsp;utf8mb4&nbsp;COLLATE&nbsp;utf8mb4_0900_ai_ci&nbsp;NULL&nbsp;DEFAULT&nbsp;NULL&nbsp;COMMENT&nbsp;<span class=\"hljs-string\" style=\"color: #98c379; line-height: 26px;\">'服务商名称'</span>,<br>&nbsp;&nbsp;`profit_amount`&nbsp;bigint&nbsp;NULL&nbsp;DEFAULT&nbsp;NULL&nbsp;COMMENT&nbsp;<span class=\"hljs-string\" style=\"color: #98c379; line-height: 26px;\">'服务商收益金额'</span>,<br>&nbsp;&nbsp;`gmt_create`&nbsp;datetime&nbsp;NOT&nbsp;NULL&nbsp;COMMENT&nbsp;<span class=\"hljs-string\" style=\"color: #98c379; line-height: 26px;\">'创建时间'</span>,<br>&nbsp;&nbsp;PRIMARY&nbsp;KEY&nbsp;(`id`)&nbsp;USING&nbsp;BTREE<br>)&nbsp;ENGINE&nbsp;=&nbsp;InnoDB&nbsp;AUTO_INCREMENT&nbsp;=&nbsp;1&nbsp;CHARACTER&nbsp;SET&nbsp;=&nbsp;utf8mb4&nbsp;COLLATE&nbsp;=&nbsp;utf8mb4_0900_ai_ci&nbsp;COMMENT&nbsp;=&nbsp;<span class=\"hljs-string\" style=\"color: #98c379; line-height: 26px;\">'服务商日收益统计'</span>&nbsp;ROW_FORMAT&nbsp;=&nbsp;DYNAMIC;<br><br></code></pre> \n<h2 data-tool=\"mdnice编辑器\" style=\"margin-top: 30px; margin-bottom: 15px; margin-left: 0px; margin-right: 0px; padding-top: 0px; padding-bottom: 0px; padding-left: 0px; padding-right: 0px; display: block;\"><span class=\"prefix\" style=\"display: none;\"></span><span class=\"content\" style=\"font-size: 22px; color: rgb(0, 0, 0); line-height: 1.5em; letter-spacing: 0em; text-align: left; font-weight: bold; display: block;\">SQL解析</span><span class=\"suffix\" style=\"display: none;\"></span></h2> \n<p data-tool=\"mdnice编辑器\" style=\"color: rgb(0, 0, 0); font-size: 16px; line-height: 1.8em; letter-spacing: 0em; text-align: left; text-indent: 0em; margin-top: 0px; margin-bottom: 0px; margin-left: 0px; margin-right: 0px; padding-top: 8px; padding-bottom: 8px; padding-left: 0px; padding-right: 0px;\"><img src=\"https://files.mdnice.com/user/63514/32587504-b37a-41c6-88ac-fc85b8fb695a.png\" alt style=\"display: block; margin-top: 0px; margin-right: auto; margin-bottom: 0px; margin-left: auto; max-width: 100%;\"> 从上图可以了解到几个点</p> \n<ol data-tool=\"mdnice编辑器\" style=\"list-style-type: decimal; margin-top: 8px; margin-bottom: 8px; margin-left: 0px; margin-right: 0px; padding-top: 0px; padding-bottom: 0px; padding-left: 25px; padding-right: 0px; color: rgb(0, 0, 0);\"> \n <li> \n  <section style=\"margin-top: 5px; margin-bottom: 5px; color: rgb(1, 1, 1); font-size: 16px; line-height: 1.8em; letter-spacing: 0em; text-align: left; font-weight: normal;\">\n    内层的联表是ALL，也很慢，虽然只有三十多万数据，时间也去到了一秒 \n  </section></li> \n <li> \n  <section style=\"margin-top: 5px; margin-bottom: 5px; color: rgb(1, 1, 1); font-size: 16px; line-height: 1.8em; letter-spacing: 0em; text-align: left; font-weight: normal;\">\n    外层A表是ALL，全表扫描非常慢 \n  </section></li> \n</ol> \n<h3 data-tool=\"mdnice编辑器\" style=\"margin-top: 30px; margin-bottom: 15px; margin-left: 0px; margin-right: 0px; padding-top: 0px; padding-bottom: 0px; padding-left: 0px; padding-right: 0px; display: block;\"><span class=\"prefix\" style=\"display: none;\"></span><span class=\"content\" style=\"font-size: 20px; color: rgb(0, 0, 0); line-height: 1.5em; letter-spacing: 0em; text-align: left; font-weight: bold; display: block;\">依次改造</span><span class=\"suffix\" style=\"display: none;\"></span></h3> \n<ol data-tool=\"mdnice编辑器\" style=\"list-style-type: decimal; margin-top: 8px; margin-bottom: 8px; margin-left: 0px; margin-right: 0px; padding-top: 0px; padding-bottom: 0px; padding-left: 25px; padding-right: 0px; color: rgb(0, 0, 0);\"> \n <li> \n  <section style=\"margin-top: 5px; margin-bottom: 5px; color: rgb(1, 1, 1); font-size: 16px; line-height: 1.8em; letter-spacing: 0em; text-align: left; font-weight: normal;\">\n    子查询中是没有带任何条件的，故在B表中新增两个参数：group_id,group_name，并为A B表关联的字段增加索引，在后续查询中将外层的条件(门店商户代理商ID)尽可能的加到子查询中，这样能直接命中索引，无需对B进行全表扫描 \n  </section></li> \n <li> \n  <section style=\"margin-top: 5px; margin-bottom: 5px; color: rgb(1, 1, 1); font-size: 16px; line-height: 1.8em; letter-spacing: 0em; text-align: left; font-weight: normal;\">\n    外层A表根据shop_id、statistics_time建立联合索引(shop_id必须放前面，区分度更加高) \n  </section></li> \n</ol> \n<h3 data-tool=\"mdnice编辑器\" style=\"margin-top: 30px; margin-bottom: 15px; margin-left: 0px; margin-right: 0px; padding-top: 0px; padding-bottom: 0px; padding-left: 0px; padding-right: 0px; display: block;\"><span class=\"prefix\" style=\"display: none;\"></span><span class=\"content\" style=\"font-size: 20px; color: rgb(0, 0, 0); line-height: 1.5em; letter-spacing: 0em; text-align: left; font-weight: bold; display: block;\">改造后SQL及其执行计划</span><span class=\"suffix\" style=\"display: none;\"></span></h3> \n<pre class=\"custom\" data-tool=\"mdnice编辑器\" style=\"border-radius: 5px; box-shadow: rgba(0, 0, 0, 0.55) 0px 2px 10px; text-align: left; margin-top: 10px; margin-bottom: 10px; margin-left: 0px; margin-right: 0px; padding-top: 0px; padding-bottom: 0px; padding-left: 0px; padding-right: 0px;\"><span style=\"display: block; background: url(https://files.mdnice.com/user/3441/876cad08-0422-409d-bb5a-08afec5da8ee.svg); height: 30px; width: 100%; background-size: 40px; background-repeat: no-repeat; background-color: #282c34; margin-bottom: -7px; border-radius: 5px; background-position: 10px 10px;\"></span><code class=\"hljs\" style=\"overflow-x: auto; padding: 16px; color: #abb2bf; padding-top: 15px; background: #282c34; border-radius: 5px; display: -webkit-box; font-family: Consolas, Monaco, Menlo, monospace; font-size: 12px;\">SELECT<br>&nbsp;COUNT(&nbsp;1&nbsp;)&nbsp;<br>FROM<br>&nbsp;shop_day_statistics&nbsp;a<br>&nbsp;LEFT&nbsp;JOIN&nbsp;(<br>&nbsp;SELECT<br>&nbsp;&nbsp;shop_id&nbsp;shop_id,<br>&nbsp;&nbsp;statistics_time,<br>&nbsp;&nbsp;merchant_id,<br>&nbsp;&nbsp;GROUP_CONCAT(&nbsp;CONCAT_ws(&nbsp;<span class=\"hljs-string\" style=\"color: #98c379; line-height: 26px;\">'-'</span>,&nbsp;service_id,&nbsp;service_name&nbsp;)&nbsp;SEPARATOR&nbsp;<span class=\"hljs-string\" style=\"color: #98c379; line-height: 26px;\">','</span>&nbsp;)&nbsp;AS&nbsp;service_name,<br>&nbsp;&nbsp;sum(&nbsp;profit_amount&nbsp;)&nbsp;profit_amount&nbsp;<br>&nbsp;FROM<br>&nbsp;&nbsp;service_day_statistics&nbsp;<br>&nbsp;WHERE<br>&nbsp;&nbsp;statistics_time&nbsp;BETWEEN&nbsp;<span class=\"hljs-string\" style=\"color: #98c379; line-height: 26px;\">'2023-09-05&nbsp;00:00:00.0'</span>&nbsp;<br>&nbsp;&nbsp;AND&nbsp;<span class=\"hljs-string\" style=\"color: #98c379; line-height: 26px;\">'2024-10-22&nbsp;00:00:00.0'</span>&nbsp;<br>&nbsp;&nbsp;AND&nbsp;shop_id&nbsp;=&nbsp;99999&nbsp;<br>&nbsp;GROUP&nbsp;BY<br>&nbsp;&nbsp;shop_id,<br>&nbsp;&nbsp;statistics_time&nbsp;<br>&nbsp;)&nbsp;s&nbsp;ON&nbsp;s.shop_id&nbsp;=&nbsp;a.shop_id&nbsp;<br>&nbsp;AND&nbsp;a.statistics_time&nbsp;=&nbsp;s.statistics_time&nbsp;<br>WHERE<br>&nbsp;a.statistics_time&nbsp;BETWEEN&nbsp;<span class=\"hljs-string\" style=\"color: #98c379; line-height: 26px;\">'2023-09-05&nbsp;00:00:00.0'</span>&nbsp;<br>&nbsp;AND&nbsp;<span class=\"hljs-string\" style=\"color: #98c379; line-height: 26px;\">'2024-10-22&nbsp;00:00:00.0'</span>&nbsp;<br>&nbsp;AND&nbsp;a.shop_id&nbsp;=&nbsp;99999;<br></code></pre> \n<figure data-tool=\"mdnice编辑器\" style=\"margin-top: 10px; margin-bottom: 10px; margin-left: 0px; margin-right: 0px; padding-top: 0px; padding-bottom: 0px; padding-left: 0px; padding-right: 0px; display: flex; flex-direction: column; justify-content: center; align-items: center;\"> \n <img src=\"https://files.mdnice.com/user/63514/98902e11-bad3-4f0a-9298-f85cb135884a.png\" alt style=\"display: block; margin-top: 0px; margin-right: auto; margin-bottom: 0px; margin-left: auto; max-width: 100%; border-top-style: none; border-bottom-style: none; border-left-style: none; border-right-style: none; border-top-width: 3px; border-bottom-width: 3px; border-left-width: 3px; border-right-width: 3px; border-top-color: rgba(0, 0, 0, 0.4); border-bottom-color: rgba(0, 0, 0, 0.4); border-left-color: rgba(0, 0, 0, 0.4); border-right-color: rgba(0, 0, 0, 0.4); border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; object-fit: fill; box-shadow: rgba(0, 0, 0, 0) 0px 0px 0px 0px;\"> \n</figure> \n<blockquote class=\"multiquote-1\" data-tool=\"mdnice编辑器\" style=\"margin-top: 20px; margin-bottom: 20px; margin-left: 0px; margin-right: 0px; padding-top: 10px; padding-bottom: 10px; padding-left: 20px; padding-right: 10px; border-top-style: none; border-bottom-style: none; border-left-style: solid; border-right-style: none; border-top-width: 3px; border-bottom-width: 3px; border-left-width: 3px; border-right-width: 3px; border-top-color: rgba(0, 0, 0, 0.4); border-bottom-color: rgba(0, 0, 0, 0.4); border-left-color: rgba(0, 0, 0, 0.4); border-right-color: rgba(0, 0, 0, 0.4); border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; background-attachment: scroll; background-clip: border-box; background-color: rgba(0, 0, 0, 0.05); background-image: none; background-origin: padding-box; background-position-x: 0%; background-position-y: 0%; background-repeat: no-repeat; background-size: auto; width: auto; height: auto; box-shadow: rgba(0, 0, 0, 0) 0px 0px 0px 0px; display: block; overflow-x: auto; overflow-y: auto;\"> <span style=\"display: none; color: rgb(0, 0, 0); font-size: 16px; line-height: 1.5em; letter-spacing: 0em; text-align: left; font-weight: normal;\"></span> \n <p style=\"text-indent: 0em; padding-top: 8px; padding-bottom: 8px; padding-left: 0px; padding-right: 0px; color: rgb(0, 0, 0); font-size: 16px; line-height: 1.8em; letter-spacing: 0em; text-align: left; font-weight: normal; margin-top: 0px; margin-right: 0px; margin-bottom: 0px; margin-left: 0px;\">到这个时候就爽了吗，从执行计划上看确实如此，但是我们忽视了这个功能是在web页面上操作的，而操作员可以任何额外条件都不输(只有时间)，那执行计划又将非常难看</p> \n</blockquote> \n<h3 data-tool=\"mdnice编辑器\" style=\"margin-top: 30px; margin-bottom: 15px; margin-left: 0px; margin-right: 0px; padding-top: 0px; padding-bottom: 0px; padding-left: 0px; padding-right: 0px; display: block;\"><span class=\"prefix\" style=\"display: none;\"></span><span class=\"content\" style=\"font-size: 20px; color: rgb(0, 0, 0); line-height: 1.5em; letter-spacing: 0em; text-align: left; font-weight: bold; display: block;\">前端限制</span><span class=\"suffix\" style=\"display: none;\"></span></h3> \n<p data-tool=\"mdnice编辑器\" style=\"color: rgb(0, 0, 0); font-size: 16px; line-height: 1.8em; letter-spacing: 0em; text-align: left; text-indent: 0em; margin-top: 0px; margin-bottom: 0px; margin-left: 0px; margin-right: 0px; padding-top: 8px; padding-bottom: 8px; padding-left: 0px; padding-right: 0px;\">限制管理后台使用人员的操作来达到我们预期的执行计划</p> \n<ol data-tool=\"mdnice编辑器\" style=\"list-style-type: decimal; margin-top: 8px; margin-bottom: 8px; margin-left: 0px; margin-right: 0px; padding-top: 0px; padding-bottom: 0px; padding-left: 25px; padding-right: 0px; color: rgb(0, 0, 0);\"> \n <li> \n  <section style=\"margin-top: 5px; margin-bottom: 5px; color: rgb(1, 1, 1); font-size: 16px; line-height: 1.8em; letter-spacing: 0em; text-align: left; font-weight: normal;\">\n    默认任何额外条件不输入时仅允许7天跨度查询 \n   <img src=\"https://files.mdnice.com/user/63514/6c81e710-5a79-4151-afa7-0ef6d38ff453.png\" alt style=\"display: block; margin-top: 0px; margin-right: auto; margin-bottom: 0px; margin-left: auto; max-width: 100%;\"> \n  </section></li> \n <li> \n  <section style=\"margin-top: 5px; margin-bottom: 5px; color: rgb(1, 1, 1); font-size: 16px; line-height: 1.8em; letter-spacing: 0em; text-align: left; font-weight: normal;\">\n    输入代理商/门店/商户ID(这几个字段都与统计时间有做联合索引)后，时间将会允许拉长跨度进行查询 \n  </section></li> \n</ol> \n<figure data-tool=\"mdnice编辑器\" style=\"margin-top: 10px; margin-bottom: 10px; margin-left: 0px; margin-right: 0px; padding-top: 0px; padding-bottom: 0px; padding-left: 0px; padding-right: 0px; display: flex; flex-direction: column; justify-content: center; align-items: center;\"> \n <img src=\"https://files.mdnice.com/user/63514/05395ca0-fee7-4728-bdb6-7a50e3cac4d4.png\" alt style=\"display: block; margin-top: 0px; margin-right: auto; margin-bottom: 0px; margin-left: auto; max-width: 100%; border-top-style: none; border-bottom-style: none; border-left-style: none; border-right-style: none; border-top-width: 3px; border-bottom-width: 3px; border-left-width: 3px; border-right-width: 3px; border-top-color: rgba(0, 0, 0, 0.4); border-bottom-color: rgba(0, 0, 0, 0.4); border-left-color: rgba(0, 0, 0, 0.4); border-right-color: rgba(0, 0, 0, 0.4); border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; object-fit: fill; box-shadow: rgba(0, 0, 0, 0) 0px 0px 0px 0px;\"> \n</figure> \n<h2 data-tool=\"mdnice编辑器\" style=\"margin-top: 30px; margin-bottom: 15px; margin-left: 0px; margin-right: 0px; padding-top: 0px; padding-bottom: 0px; padding-left: 0px; padding-right: 0px; display: block;\"><span class=\"prefix\" style=\"display: none;\"></span><span class=\"content\" style=\"font-size: 22px; color: rgb(0, 0, 0); line-height: 1.5em; letter-spacing: 0em; text-align: left; font-weight: bold; display: block;\">写到最后</span><span class=\"suffix\" style=\"display: none;\"></span></h2> \n<p data-tool=\"mdnice编辑器\" style=\"color: rgb(0, 0, 0); font-size: 16px; line-height: 1.8em; letter-spacing: 0em; text-align: left; text-indent: 0em; margin-top: 0px; margin-bottom: 0px; margin-left: 0px; margin-right: 0px; padding-top: 8px; padding-bottom: 8px; padding-left: 0px; padding-right: 0px;\">对于一个SQL的优化我感触比较深的是：不能仅从SQL本身去进行优化，而需要结合具体的业务进行权衡从而选择一个合适的方案进行优化，目前项目也到高速上升期，出现了很多大表，未来系统将会有更多的问题，当然这即是问题也是挑战，加油！！！</p>",
                "title": "MySQL五千万大表查询优化实战",
                "categoryId": 1,
                "categoryName": "后端",
                "tagId": 170,
                "tagName": "数据库",
                "userId": 63514,
                "userOutId": "225649775614",
                "username": "稍许",
                "avatar": "",
                "description": "背景DBA同事在钉钉发了两张截图，作为“始作俑者”的我很心虚，因为刚才是我在管理后台查询数据，结果很久都没出来，并且用多个维度查了N次问题分析这是当天上线的功能，完事我立马锁定SQL然后开启排查#&n",
                "level": 1,
                "publishTime": "2024/10/09",
                "readingNum": 4,
                "likeNum": 0,
                "introduction": null,
                "followWords": null,
                "followPic": null,
                "isFollowing": false,
                "isLike": false,
                "isSelf": false,
                "type": 1,
                "isVisible": true,
                "invisibleReason": null,
                "writingColumn": {
                    "columnOutId": "7b7fe68c59064a138cfff5136ba25c4a",
                    "name": "默认专栏",
                    "briefIntro": "这是一个默认专栏",
                    "cover": "https://files.mdnice.com/common/community/default-column-cover.jpg",
                    "writingNum": 6,
                    "createTime": "2024-08-06 19:03"
                }
            }
        },
        "__N_SSP": true
    },
    "page": "/writing/[id]",
    "query": {
        "id": "ca71dd61044d4f51a309aaebe68e5130"
    },
    "buildId": "ErZPkD4oq6iwH2nj6Dpcx",
    "isFallback": false,
    "gssp": true,
    "appGip": true
}