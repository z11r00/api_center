{
    "props": {
        "pageProps": {
            "query": {
                "id": "fd46c72f863c4c269cd02503dc6e13a1"
            },
            "ieBrowser": false,
            "needRefresh": false,
            "writingDetail": {
                "id": 85257,
                "outId": "fd46c72f863c4c269cd02503dc6e13a1",
                "articleOutId": "fd46c72f863c4c269cd02503dc6e13a1",
                "html": "<h1 data-tool=\"mdnice编辑器\" style=\"margin-top: 30px; margin-bottom: 15px; padding: 0px; font-weight: bold; color: black; font-size: 24px;\"><span class=\"prefix\" style=\"display: none;\"></span><span class=\"content\">ERA5下载加速</span><span class=\"suffix\"></span></h1> \n<h2 data-tool=\"mdnice编辑器\" style=\"margin-top: 30px; margin-bottom: 15px; padding: 0px; font-weight: bold; color: black; font-size: 22px;\"><span class=\"prefix\" style=\"display: none;\"></span><span class=\"content\" style=\"background-color: #F7D3CC; color: #FFF; padding: 5px 15px; border-radius: 1px;\">引言</span><span class=\"suffix\"></span></h2> \n<p data-tool=\"mdnice编辑器\" style=\"padding-top: 8px; padding-bottom: 8px; margin: 0; line-height: 26px; color: black; font-size: 17px; word-spacing: 3px; letter-spacing: 1px;\">众所周知，ERA5小时尺度以及日尺度数据下载比较困难，一方面是由于数据中心在欧洲，传输速度慢。另一方面也是由于数据量庞大。</p> \n<p data-tool=\"mdnice编辑器\" style=\"padding-top: 8px; padding-bottom: 8px; margin: 0; line-height: 26px; color: black; font-size: 17px; word-spacing: 3px; letter-spacing: 1px;\">目前批量下载的代码有很多，但是存在以下问题：</p> \n<ul data-tool=\"mdnice编辑器\" style=\"margin-top: 8px; margin-bottom: 8px; padding-left: 25px; color: black; list-style-type: disc;\"> \n <li> \n  <section style=\"margin-top: 5px; margin-bottom: 5px; line-height: 26px; text-align: left; color: rgb(1,1,1); font-weight: 500;\">\n    速度慢，几十到几百kb \n  </section></li> \n <li> \n  <section style=\"margin-top: 5px; margin-bottom: 5px; line-height: 26px; text-align: left; color: rgb(1,1,1); font-weight: 500;\">\n    下载容易中断，生成无效文件 \n  </section></li> \n <li> \n  <section style=\"margin-top: 5px; margin-bottom: 5px; line-height: 26px; text-align: left; color: rgb(1,1,1); font-weight: 500;\">\n    单一线程，提交任务然后等待，速度慢 \n  </section></li> \n <li> \n  <section style=\"margin-top: 5px; margin-bottom: 5px; line-height: 26px; text-align: left; color: rgb(1,1,1); font-weight: 500;\">\n    中断下载后，重新提交很麻烦，先找到中断的位置 \n  </section></li> \n</ul> \n<p data-tool=\"mdnice编辑器\" style=\"padding-top: 8px; padding-bottom: 8px; margin: 0; line-height: 26px; color: black; font-size: 17px; word-spacing: 3px; letter-spacing: 1px;\">目前ECMWF数据进行了一些更新，界面更新。</p> \n<figure data-tool=\"mdnice编辑器\" style=\"margin: 0; margin-top: 10px; margin-bottom: 10px; display: flex; flex-direction: column; justify-content: center; align-items: center;\"> \n <img src=\"https://files.mdnice.com/user/40204/6785129c-4285-4ad9-a741-8ee2b2a7c78d.png\" alt=\"image-20241018190725470\" style=\"display: block; margin: 0 auto; max-width: 100%; border-radius: 10px; border: 3px solid #F7D3CC;\"> \n <figcaption style=\"margin-top: 5px; text-align: center; color: #888; font-size: 14px;\">\n   image-20241018190725470 \n </figcaption> \n</figure> \n<p data-tool=\"mdnice编辑器\" style=\"padding-top: 8px; padding-bottom: 8px; margin: 0; line-height: 26px; color: black; font-size: 17px; word-spacing: 3px; letter-spacing: 1px;\">且新增了daily数据，和Google Earth Engine也一致了，变量更全。</p> \n<p data-tool=\"mdnice编辑器\" style=\"padding-top: 8px; padding-bottom: 8px; margin: 0; line-height: 26px; color: black; font-size: 17px; word-spacing: 3px; letter-spacing: 1px;\">借此机会讲述一下流程</p> \n<h2 data-tool=\"mdnice编辑器\" style=\"margin-top: 30px; margin-bottom: 15px; padding: 0px; font-weight: bold; color: black; font-size: 22px;\"><span class=\"prefix\" style=\"display: none;\"></span><span class=\"content\" style=\"background-color: #F7D3CC; color: #FFF; padding: 5px 15px; border-radius: 1px;\">预备工作</span><span class=\"suffix\"></span></h2> \n<p data-tool=\"mdnice编辑器\" style=\"padding-top: 8px; padding-bottom: 8px; margin: 0; line-height: 26px; color: black; font-size: 17px; word-spacing: 3px; letter-spacing: 1px;\">首先需要安装ECMWF提供的Python库</p> \n<pre class=\"custom\" data-tool=\"mdnice编辑器\" style=\"margin-top: 10px; margin-bottom: 10px;\"><code class=\"hljs\" style=\"overflow-x: auto; padding: 16px; color: #333; background: #f8f8f8; display: -webkit-box; font-family: Operator Mono, Consolas, Monaco, Menlo, monospace; border-radius: 0px; font-size: 12px; -webkit-overflow-scrolling: touch;\">pip&nbsp;install&nbsp;cdsapi<br></code></pre> \n<p data-tool=\"mdnice编辑器\" style=\"padding-top: 8px; padding-bottom: 8px; margin: 0; line-height: 26px; color: black; font-size: 17px; word-spacing: 3px; letter-spacing: 1px;\">接下来注册ECMWF账号，在这里注册<a href=\"https://cds.climate.copernicus.eu/how-to-api\" style=\"text-decoration: none; color: #1e6bb8; word-wrap: break-word; font-weight: bold; border-bottom: 1px solid #1e6bb8;\">Climate Data Store (copernicus.eu)</a></p> \n<p data-tool=\"mdnice编辑器\" style=\"padding-top: 8px; padding-bottom: 8px; margin: 0; line-height: 26px; color: black; font-size: 17px; word-spacing: 3px; letter-spacing: 1px;\">然后打开：</p> \n<p data-tool=\"mdnice编辑器\" style=\"padding-top: 8px; padding-bottom: 8px; margin: 0; line-height: 26px; color: black; font-size: 17px; word-spacing: 3px; letter-spacing: 1px;\">https://cds.climate.copernicus.eu/how-to-api</p> \n<p data-tool=\"mdnice编辑器\" style=\"padding-top: 8px; padding-bottom: 8px; margin: 0; line-height: 26px; color: black; font-size: 17px; word-spacing: 3px; letter-spacing: 1px;\">就能看到url和key</p> \n<figure data-tool=\"mdnice编辑器\" style=\"margin: 0; margin-top: 10px; margin-bottom: 10px; display: flex; flex-direction: column; justify-content: center; align-items: center;\"> \n <img src=\"https://files.mdnice.com/user/40204/0996b073-92f7-488b-a9d4-593635167f79.png\" alt=\"image-20241018194210936\" style=\"display: block; margin: 0 auto; max-width: 100%; border-radius: 10px; border: 3px solid #F7D3CC;\"> \n <figcaption style=\"margin-top: 5px; text-align: center; color: #888; font-size: 14px;\">\n   image-20241018194210936 \n </figcaption> \n</figure> \n<p data-tool=\"mdnice编辑器\" style=\"padding-top: 8px; padding-bottom: 8px; margin: 0; line-height: 26px; color: black; font-size: 17px; word-spacing: 3px; letter-spacing: 1px;\">配置文件，C:\\Users\\user_name\\下应该是没有.cdsapi配置文件的，需要自己手动创一个：可以打开记事本，然后复制、粘贴、保存，文件名为.cdsapi，内容如下图<strong style=\"font-weight: bold; color: black;\">注意保存类型选择所有文件</strong></p> \n<figure data-tool=\"mdnice编辑器\" style=\"margin: 0; margin-top: 10px; margin-bottom: 10px; display: flex; flex-direction: column; justify-content: center; align-items: center;\"> \n <img src=\"https://files.mdnice.com/user/40204/899f1e30-3845-4de2-a67b-f631d68e1a51.png\" alt=\"image-20241018194322681\" style=\"display: block; margin: 0 auto; max-width: 100%; border-radius: 10px; border: 3px solid #F7D3CC;\"> \n <figcaption style=\"margin-top: 5px; text-align: center; color: #888; font-size: 14px;\">\n   image-20241018194322681 \n </figcaption> \n</figure> \n<h2 data-tool=\"mdnice编辑器\" style=\"margin-top: 30px; margin-bottom: 15px; padding: 0px; font-weight: bold; color: black; font-size: 22px;\"><span class=\"prefix\" style=\"display: none;\"></span><span class=\"content\" style=\"background-color: #F7D3CC; color: #FFF; padding: 5px 15px; border-radius: 1px;\">代码</span><span class=\"suffix\"></span></h2> \n<p data-tool=\"mdnice编辑器\" style=\"padding-top: 8px; padding-bottom: 8px; margin: 0; line-height: 26px; color: black; font-size: 17px; word-spacing: 3px; letter-spacing: 1px;\">这里直接放代码，使用queue来多线程提速，同时处理4个任务</p> \n<pre class=\"custom\" data-tool=\"mdnice编辑器\" style=\"margin-top: 10px; margin-bottom: 10px;\"><code class=\"hljs\" style=\"overflow-x: auto; padding: 16px; color: #333; background: #f8f8f8; display: -webkit-box; font-family: Operator Mono, Consolas, Monaco, Menlo, monospace; border-radius: 0px; font-size: 12px; -webkit-overflow-scrolling: touch;\">import&nbsp;cdsapi<br>import&nbsp;os<br>import&nbsp;calendar<br>import&nbsp;netCDF4&nbsp;as&nbsp;nc<br>import&nbsp;threading<br>from&nbsp;queue&nbsp;import&nbsp;Queue<br>os.environ[<span class=\"hljs-string\" style=\"color: #d14; line-height: 26px;\">'KMP_DUPLICATE_LIB_OK'</span>]&nbsp;=&nbsp;<span class=\"hljs-string\" style=\"color: #d14; line-height: 26px;\">'True'</span><br><span class=\"hljs-comment\" style=\"color: #998; font-style: italic; line-height: 26px;\">#&nbsp;创建一个函数来构建下载请求</span><br>def&nbsp;download_era5_data(year,&nbsp;month,&nbsp;day,&nbsp;download_dir):<br>&nbsp;&nbsp;&nbsp;&nbsp;dataset&nbsp;=&nbsp;<span class=\"hljs-string\" style=\"color: #d14; line-height: 26px;\">\"derived-era5-pressure-levels-daily-statistics\"</span><br>&nbsp;&nbsp;&nbsp;&nbsp;request&nbsp;=&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class=\"hljs-string\" style=\"color: #d14; line-height: 26px;\">\"product_type\"</span>:&nbsp;<span class=\"hljs-string\" style=\"color: #d14; line-height: 26px;\">\"reanalysis\"</span>,<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class=\"hljs-string\" style=\"color: #d14; line-height: 26px;\">\"variable\"</span>:&nbsp;[<span class=\"hljs-string\" style=\"color: #d14; line-height: 26px;\">\"geopotential\"</span>],<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class=\"hljs-string\" style=\"color: #d14; line-height: 26px;\">\"year\"</span>:&nbsp;year,<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class=\"hljs-string\" style=\"color: #d14; line-height: 26px;\">\"month\"</span>:&nbsp;[month],<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class=\"hljs-string\" style=\"color: #d14; line-height: 26px;\">\"day\"</span>:&nbsp;[day],<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class=\"hljs-string\" style=\"color: #d14; line-height: 26px;\">\"pressure_level\"</span>:&nbsp;[<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class=\"hljs-string\" style=\"color: #d14; line-height: 26px;\">\"300\"</span>,&nbsp;<span class=\"hljs-string\" style=\"color: #d14; line-height: 26px;\">\"500\"</span>,&nbsp;<span class=\"hljs-string\" style=\"color: #d14; line-height: 26px;\">\"700\"</span>,<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class=\"hljs-string\" style=\"color: #d14; line-height: 26px;\">\"850\"</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;],<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class=\"hljs-string\" style=\"color: #d14; line-height: 26px;\">\"daily_statistic\"</span>:&nbsp;<span class=\"hljs-string\" style=\"color: #d14; line-height: 26px;\">\"daily_mean\"</span>,<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class=\"hljs-string\" style=\"color: #d14; line-height: 26px;\">\"time_zone\"</span>:&nbsp;<span class=\"hljs-string\" style=\"color: #d14; line-height: 26px;\">\"utc+00:00\"</span>,<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class=\"hljs-string\" style=\"color: #d14; line-height: 26px;\">\"frequency\"</span>:&nbsp;<span class=\"hljs-string\" style=\"color: #d14; line-height: 26px;\">\"6_hourly\"</span><br>&nbsp;&nbsp;&nbsp;&nbsp;}<br><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class=\"hljs-comment\" style=\"color: #998; font-style: italic; line-height: 26px;\">#&nbsp;定义文件名格式为&nbsp;年月日.nc，并设置下载路径</span><br>&nbsp;&nbsp;&nbsp;&nbsp;filename&nbsp;=&nbsp;f<span class=\"hljs-string\" style=\"color: #d14; line-height: 26px;\">\"ERA5_{year}{month}{day}.nc\"</span><br>&nbsp;&nbsp;&nbsp;&nbsp;filepath&nbsp;=&nbsp;os.path.join(download_dir,&nbsp;filename)<br><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class=\"hljs-built_in\" style=\"color: #0086b3; line-height: 26px;\">print</span>(f<span class=\"hljs-string\" style=\"color: #d14; line-height: 26px;\">\"Checking&nbsp;if&nbsp;file&nbsp;{filename}&nbsp;exists&nbsp;and&nbsp;is&nbsp;complete...\"</span>)<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class=\"hljs-comment\" style=\"color: #998; font-style: italic; line-height: 26px;\">#&nbsp;检查文件是否已存在，且文件完整</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class=\"hljs-keyword\" style=\"color: #333; font-weight: bold; line-height: 26px;\">if</span>&nbsp;os.path.exists(filepath):<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;try:<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class=\"hljs-comment\" style=\"color: #998; font-style: italic; line-height: 26px;\">#&nbsp;尝试打开文件以验证其完整性</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;with&nbsp;nc.Dataset(filepath,&nbsp;<span class=\"hljs-string\" style=\"color: #d14; line-height: 26px;\">'r'</span>)&nbsp;as&nbsp;ds:<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class=\"hljs-built_in\" style=\"color: #0086b3; line-height: 26px;\">print</span>(f<span class=\"hljs-string\" style=\"color: #d14; line-height: 26px;\">\"File&nbsp;{filename}&nbsp;is&nbsp;complete&nbsp;and&nbsp;valid.\"</span>)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;except&nbsp;OSError&nbsp;as&nbsp;e:<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class=\"hljs-comment\" style=\"color: #998; font-style: italic; line-height: 26px;\">#&nbsp;如果文件不完整或损坏，删除并重新下载</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class=\"hljs-built_in\" style=\"color: #0086b3; line-height: 26px;\">print</span>(f<span class=\"hljs-string\" style=\"color: #d14; line-height: 26px;\">\"File&nbsp;{filename}&nbsp;is&nbsp;corrupted.&nbsp;Redownloading...\"</span>)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;os.remove(filepath)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;download_file_from_era5(request,&nbsp;filepath)<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class=\"hljs-keyword\" style=\"color: #333; font-weight: bold; line-height: 26px;\">else</span>:<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class=\"hljs-comment\" style=\"color: #998; font-style: italic; line-height: 26px;\">#&nbsp;如果文件不存在，则直接下载</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class=\"hljs-built_in\" style=\"color: #0086b3; line-height: 26px;\">print</span>(f<span class=\"hljs-string\" style=\"color: #d14; line-height: 26px;\">\"File&nbsp;{filename}&nbsp;does&nbsp;not&nbsp;exist.&nbsp;Starting&nbsp;download...\"</span>)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;download_file_from_era5(request,&nbsp;filepath)<br><br><span class=\"hljs-comment\" style=\"color: #998; font-style: italic; line-height: 26px;\">#&nbsp;创建一个函数来执行实际下载</span><br>def&nbsp;download_file_from_era5(request,&nbsp;filepath):<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class=\"hljs-built_in\" style=\"color: #0086b3; line-height: 26px;\">print</span>(f<span class=\"hljs-string\" style=\"color: #d14; line-height: 26px;\">\"Downloading&nbsp;data&nbsp;to&nbsp;{filepath}...\"</span>)<br>&nbsp;&nbsp;&nbsp;&nbsp;client&nbsp;=&nbsp;cdsapi.Client()<br>&nbsp;&nbsp;&nbsp;&nbsp;client.retrieve(<span class=\"hljs-string\" style=\"color: #d14; line-height: 26px;\">\"derived-era5-pressure-levels-daily-statistics\"</span>,&nbsp;request).download(filepath)<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class=\"hljs-built_in\" style=\"color: #0086b3; line-height: 26px;\">print</span>(f<span class=\"hljs-string\" style=\"color: #d14; line-height: 26px;\">\"Download&nbsp;completed&nbsp;for&nbsp;{filepath}\"</span>)<br><br><span class=\"hljs-comment\" style=\"color: #998; font-style: italic; line-height: 26px;\">#&nbsp;定义下载目录</span><br>download_dir&nbsp;=&nbsp;r<span class=\"hljs-string\" style=\"color: #d14; line-height: 26px;\">\"F:\\ERA5\\surface\\geopotential\"</span><br><br><span class=\"hljs-built_in\" style=\"color: #0086b3; line-height: 26px;\">print</span>(f<span class=\"hljs-string\" style=\"color: #d14; line-height: 26px;\">\"Checking&nbsp;if&nbsp;download&nbsp;directory&nbsp;{download_dir}&nbsp;exists...\"</span>)<br><span class=\"hljs-comment\" style=\"color: #998; font-style: italic; line-height: 26px;\">#&nbsp;检查目录是否存在，不存在则创建</span><br><span class=\"hljs-keyword\" style=\"color: #333; font-weight: bold; line-height: 26px;\">if</span>&nbsp;not&nbsp;os.path.exists(download_dir):<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class=\"hljs-built_in\" style=\"color: #0086b3; line-height: 26px;\">print</span>(f<span class=\"hljs-string\" style=\"color: #d14; line-height: 26px;\">\"Directory&nbsp;{download_dir}&nbsp;does&nbsp;not&nbsp;exist.&nbsp;Creating&nbsp;directory...\"</span>)<br>&nbsp;&nbsp;&nbsp;&nbsp;os.makedirs(download_dir)<br><span class=\"hljs-keyword\" style=\"color: #333; font-weight: bold; line-height: 26px;\">else</span>:<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class=\"hljs-built_in\" style=\"color: #0086b3; line-height: 26px;\">print</span>(f<span class=\"hljs-string\" style=\"color: #d14; line-height: 26px;\">\"Directory&nbsp;{download_dir}&nbsp;already&nbsp;exists.\"</span>)<br><br><span class=\"hljs-comment\" style=\"color: #998; font-style: italic; line-height: 26px;\">#&nbsp;定义下载任务队列</span><br>queue&nbsp;=&nbsp;Queue()<br><br><span class=\"hljs-comment\" style=\"color: #998; font-style: italic; line-height: 26px;\">#&nbsp;创建一个下载工作线程类</span><br>class&nbsp;DownloadWorker(threading.Thread):<br>&nbsp;&nbsp;&nbsp;&nbsp;def&nbsp;__init__(self,&nbsp;queue):<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;threading.Thread.__init__(self)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self.queue&nbsp;=&nbsp;queue<br><br>&nbsp;&nbsp;&nbsp;&nbsp;def&nbsp;run(self):<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class=\"hljs-keyword\" style=\"color: #333; font-weight: bold; line-height: 26px;\">while</span>&nbsp;True:<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;year,&nbsp;month,&nbsp;day&nbsp;=&nbsp;self.queue.get()<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class=\"hljs-built_in\" style=\"color: #0086b3; line-height: 26px;\">print</span>(f<span class=\"hljs-string\" style=\"color: #d14; line-height: 26px;\">\"Worker&nbsp;{threading.current_thread().name}&nbsp;processing&nbsp;download&nbsp;for&nbsp;{year}-{month:02d}-{day:02d}...\"</span>)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;try:<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class=\"hljs-comment\" style=\"color: #998; font-style: italic; line-height: 26px;\">#&nbsp;将月份和日期格式化为两位数</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;month_str&nbsp;=&nbsp;f<span class=\"hljs-string\" style=\"color: #d14; line-height: 26px;\">\"{month:02d}\"</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;day_str&nbsp;=&nbsp;f<span class=\"hljs-string\" style=\"color: #d14; line-height: 26px;\">\"{day:02d}\"</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;download_era5_data(str(year),&nbsp;month_str,&nbsp;day_str,&nbsp;download_dir)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;except&nbsp;Exception&nbsp;as&nbsp;e:<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class=\"hljs-built_in\" style=\"color: #0086b3; line-height: 26px;\">print</span>(f<span class=\"hljs-string\" style=\"color: #d14; line-height: 26px;\">\"Error&nbsp;downloading&nbsp;data&nbsp;for&nbsp;{year}-{month_str}-{day_str}:&nbsp;{e}\"</span>)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;finally:<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class=\"hljs-built_in\" style=\"color: #0086b3; line-height: 26px;\">print</span>(f<span class=\"hljs-string\" style=\"color: #d14; line-height: 26px;\">\"Worker&nbsp;{threading.current_thread().name}&nbsp;finished&nbsp;processing&nbsp;download&nbsp;for&nbsp;{year}-{month:02d}-{day:02d}.\"</span>)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self.queue.task_done()<br><br><span class=\"hljs-comment\" style=\"color: #998; font-style: italic; line-height: 26px;\">#&nbsp;创建四个工作线程</span><br><span class=\"hljs-built_in\" style=\"color: #0086b3; line-height: 26px;\">print</span>(<span class=\"hljs-string\" style=\"color: #d14; line-height: 26px;\">\"Creating&nbsp;worker&nbsp;threads...\"</span>)<br><span class=\"hljs-keyword\" style=\"color: #333; font-weight: bold; line-height: 26px;\">for</span>&nbsp;x&nbsp;<span class=\"hljs-keyword\" style=\"color: #333; font-weight: bold; line-height: 26px;\">in</span>&nbsp;range(4):<br>&nbsp;&nbsp;&nbsp;&nbsp;worker&nbsp;=&nbsp;DownloadWorker(queue)<br>&nbsp;&nbsp;&nbsp;&nbsp;worker.daemon&nbsp;=&nbsp;True<br>&nbsp;&nbsp;&nbsp;&nbsp;worker.start()<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class=\"hljs-built_in\" style=\"color: #0086b3; line-height: 26px;\">print</span>(f<span class=\"hljs-string\" style=\"color: #d14; line-height: 26px;\">\"Worker&nbsp;thread&nbsp;{worker.name}&nbsp;started.\"</span>)<br><br><span class=\"hljs-comment\" style=\"color: #998; font-style: italic; line-height: 26px;\">#&nbsp;循环遍历2000到2023年，将任务加入队列</span><br><span class=\"hljs-built_in\" style=\"color: #0086b3; line-height: 26px;\">print</span>(<span class=\"hljs-string\" style=\"color: #d14; line-height: 26px;\">\"Adding&nbsp;download&nbsp;tasks&nbsp;to&nbsp;the&nbsp;queue...\"</span>)<br><span class=\"hljs-keyword\" style=\"color: #333; font-weight: bold; line-height: 26px;\">for</span>&nbsp;year&nbsp;<span class=\"hljs-keyword\" style=\"color: #333; font-weight: bold; line-height: 26px;\">in</span>&nbsp;range(2000,&nbsp;2024):<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class=\"hljs-keyword\" style=\"color: #333; font-weight: bold; line-height: 26px;\">for</span>&nbsp;month&nbsp;<span class=\"hljs-keyword\" style=\"color: #333; font-weight: bold; line-height: 26px;\">in</span>&nbsp;range(1,&nbsp;13):<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class=\"hljs-comment\" style=\"color: #998; font-style: italic; line-height: 26px;\">#&nbsp;获取当前月份的最大天数</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;_,&nbsp;max_day&nbsp;=&nbsp;calendar.monthrange(year,&nbsp;month)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class=\"hljs-keyword\" style=\"color: #333; font-weight: bold; line-height: 26px;\">for</span>&nbsp;day&nbsp;<span class=\"hljs-keyword\" style=\"color: #333; font-weight: bold; line-height: 26px;\">in</span>&nbsp;range(1,&nbsp;max_day&nbsp;+&nbsp;1):<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class=\"hljs-built_in\" style=\"color: #0086b3; line-height: 26px;\">print</span>(f<span class=\"hljs-string\" style=\"color: #d14; line-height: 26px;\">\"Adding&nbsp;task&nbsp;for&nbsp;{year}-{month:02d}-{day:02d}&nbsp;to&nbsp;the&nbsp;queue...\"</span>)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;queue.put((year,&nbsp;month,&nbsp;day))<br><br><span class=\"hljs-comment\" style=\"color: #998; font-style: italic; line-height: 26px;\">#&nbsp;等待所有任务完成</span><br><span class=\"hljs-built_in\" style=\"color: #0086b3; line-height: 26px;\">print</span>(<span class=\"hljs-string\" style=\"color: #d14; line-height: 26px;\">\"Waiting&nbsp;for&nbsp;all&nbsp;tasks&nbsp;to&nbsp;complete...\"</span>)<br>queue.join()<br><span class=\"hljs-built_in\" style=\"color: #0086b3; line-height: 26px;\">print</span>(<span class=\"hljs-string\" style=\"color: #d14; line-height: 26px;\">\"All&nbsp;download&nbsp;tasks&nbsp;completed.\"</span>)<br><br></code></pre> \n<p data-tool=\"mdnice编辑器\" style=\"padding-top: 8px; padding-bottom: 8px; margin: 0; line-height: 26px; color: black; font-size: 17px; word-spacing: 3px; letter-spacing: 1px;\">代码需要修改<code style=\"font-size: 14px; word-wrap: break-word; padding: 2px 4px; border-radius: 4px; margin: 0 2px; color: #1e6bb8; background-color: rgba(27,31,35,.05); font-family: Operator Mono, Consolas, Monaco, Menlo, monospace; word-break: break-all;\">dataset</code>和<code style=\"font-size: 14px; word-wrap: break-word; padding: 2px 4px; border-radius: 4px; margin: 0 2px; color: #1e6bb8; background-color: rgba(27,31,35,.05); font-family: Operator Mono, Consolas, Monaco, Menlo, monospace; word-break: break-all;\">request</code></p> \n<p data-tool=\"mdnice编辑器\" style=\"padding-top: 8px; padding-bottom: 8px; margin: 0; line-height: 26px; color: black; font-size: 17px; word-spacing: 3px; letter-spacing: 1px;\">一般是先手动预选择需要下载的数据，然后复制API提供的内容并替换：</p> \n<figure data-tool=\"mdnice编辑器\" style=\"margin: 0; margin-top: 10px; margin-bottom: 10px; display: flex; flex-direction: column; justify-content: center; align-items: center;\"> \n <img src=\"https://files.mdnice.com/user/40204/c29908ad-58f7-4465-bd07-116f03f458f6.png\" alt=\"image-20241018194955738\" style=\"display: block; margin: 0 auto; max-width: 100%; border-radius: 10px; border: 3px solid #F7D3CC;\"> \n <figcaption style=\"margin-top: 5px; text-align: center; color: #888; font-size: 14px;\">\n   image-20241018194955738 \n </figcaption> \n</figure> \n<p data-tool=\"mdnice编辑器\" style=\"padding-top: 8px; padding-bottom: 8px; margin: 0; line-height: 26px; color: black; font-size: 17px; word-spacing: 3px; letter-spacing: 1px;\">然后替换路径即可</p> \n<p data-tool=\"mdnice编辑器\" style=\"padding-top: 8px; padding-bottom: 8px; margin: 0; line-height: 26px; color: black; font-size: 17px; word-spacing: 3px; letter-spacing: 1px;\">这里是每天下载一个文件，也可以按照你的需求更改循环代码</p> \n<p data-tool=\"mdnice编辑器\" style=\"padding-top: 8px; padding-bottom: 8px; margin: 0; line-height: 26px; color: black; font-size: 17px; word-spacing: 3px; letter-spacing: 1px;\">代码有几个优点，可以说得上是ERA5下载的终极版了：</p> \n<ul data-tool=\"mdnice编辑器\" style=\"margin-top: 8px; margin-bottom: 8px; padding-left: 25px; color: black; list-style-type: disc;\"> \n <li> \n  <section style=\"margin-top: 5px; margin-bottom: 5px; line-height: 26px; text-align: left; color: rgb(1,1,1); font-weight: 500;\"> \n   <p style=\"padding-top: 8px; padding-bottom: 8px; margin: 0; line-height: 26px; color: black; font-size: 17px; word-spacing: 3px; letter-spacing: 1px;\">中断下载可以反复运行，补充未下载的内容</p> \n  </section></li> \n <li> \n  <section style=\"margin-top: 5px; margin-bottom: 5px; line-height: 26px; text-align: left; color: rgb(1,1,1); font-weight: 500;\"> \n   <p style=\"padding-top: 8px; padding-bottom: 8px; margin: 0; line-height: 26px; color: black; font-size: 17px; word-spacing: 3px; letter-spacing: 1px;\">可以按照循环内所有的文件，检测下载中断的文件，并重新下载</p> \n  </section></li> \n <li> \n  <section style=\"margin-top: 5px; margin-bottom: 5px; line-height: 26px; text-align: left; color: rgb(1,1,1); font-weight: 500;\"> \n   <p style=\"padding-top: 8px; padding-bottom: 8px; margin: 0; line-height: 26px; color: black; font-size: 17px; word-spacing: 3px; letter-spacing: 1px;\">四线程提速</p> \n  </section></li> \n <li> \n  <section style=\"margin-top: 5px; margin-bottom: 5px; line-height: 26px; text-align: left; color: rgb(1,1,1); font-weight: 500;\"> \n   <p style=\"padding-top: 8px; padding-bottom: 8px; margin: 0; line-height: 26px; color: black; font-size: 17px; word-spacing: 3px; letter-spacing: 1px;\">无需借助任何辅助下载软件</p> \n  </section></li> \n</ul> \n<h2 data-tool=\"mdnice编辑器\" style=\"margin-top: 30px; margin-bottom: 15px; padding: 0px; font-weight: bold; color: black; font-size: 22px;\"><span class=\"prefix\" style=\"display: none;\"></span><span class=\"content\" style=\"background-color: #F7D3CC; color: #FFF; padding: 5px 15px; border-radius: 1px;\">下载提速</span><span class=\"suffix\"></span></h2> \n<p data-tool=\"mdnice编辑器\" style=\"padding-top: 8px; padding-bottom: 8px; margin: 0; line-height: 26px; color: black; font-size: 17px; word-spacing: 3px; letter-spacing: 1px;\">一般来说下载速度还是比较快的，大多数在几M/s，偶尔也会几百k/s</p> \n<p data-tool=\"mdnice编辑器\" style=\"padding-top: 8px; padding-bottom: 8px; margin: 0; line-height: 26px; color: black; font-size: 17px; word-spacing: 3px; letter-spacing: 1px;\">这里采用气象家园-kermit 提供的方法。</p> \n<p data-tool=\"mdnice编辑器\" style=\"padding-top: 8px; padding-bottom: 8px; margin: 0; line-height: 26px; color: black; font-size: 17px; word-spacing: 3px; letter-spacing: 1px;\">找到下载的cdsapi库的安装目录，打开目录下的api.py，一般可以在conda环境中找到</p> \n<p data-tool=\"mdnice编辑器\" style=\"padding-top: 8px; padding-bottom: 8px; margin: 0; line-height: 26px; color: black; font-size: 17px; word-spacing: 3px; letter-spacing: 1px;\">搜索这段代码：</p> \n<pre class=\"custom\" data-tool=\"mdnice编辑器\" style=\"margin-top: 10px; margin-bottom: 10px;\"><code class=\"hljs\" style=\"overflow-x: auto; padding: 16px; color: #333; background: #f8f8f8; display: -webkit-box; font-family: Operator Mono, Consolas, Monaco, Menlo, monospace; border-radius: 0px; font-size: 12px; -webkit-overflow-scrolling: touch;\">def&nbsp;_download(self,&nbsp;url,&nbsp;size,&nbsp;target):&nbsp;<br></code></pre> \n<p data-tool=\"mdnice编辑器\" style=\"padding-top: 8px; padding-bottom: 8px; margin: 0; line-height: 26px; color: black; font-size: 17px; word-spacing: 3px; letter-spacing: 1px;\">在这段代码中添加下面一行代码，然后保存</p> \n<pre class=\"custom\" data-tool=\"mdnice编辑器\" style=\"margin-top: 10px; margin-bottom: 10px;\"><code class=\"hljs\" style=\"overflow-x: auto; padding: 16px; color: #333; background: #f8f8f8; display: -webkit-box; font-family: Operator Mono, Consolas, Monaco, Menlo, monospace; border-radius: 0px; font-size: 12px; -webkit-overflow-scrolling: touch;\">url=url.replace(<span class=\"hljs-string\" style=\"color: #d14; line-height: 26px;\">\".copernicus-climate.eu\"</span>,<span class=\"hljs-string\" style=\"color: #d14; line-height: 26px;\">\".nuist.love\"</span>)<br></code></pre> \n<p data-tool=\"mdnice编辑器\" style=\"padding-top: 8px; padding-bottom: 8px; margin: 0; line-height: 26px; color: black; font-size: 17px; word-spacing: 3px; letter-spacing: 1px;\">这个url是他做的镜像网站，在一些情况下可以加速。</p>",
                "title": "新版ERA5下载多线程加速，看这一篇就行了",
                "categoryId": 3,
                "categoryName": "人工智能",
                "tagId": 116,
                "tagName": "机器学习",
                "userId": 40204,
                "userOutId": "706880289656",
                "username": "LonghaoWang",
                "avatar": "https://files.mdnice.com/pic/20a54d83-6259-4b66-8689-c8ce6b9e8616.jpg",
                "description": "ERA5下载加速引言众所周知，ERA5小时尺度以及日尺度数据下载比较困难，一方面是由于数据中心在欧洲，传输速度慢。另一方面也是由于数据量庞大。目前批量下载的代码有很多，但是存在以下问题：速度慢，几十到",
                "level": 2,
                "publishTime": "2024/10/18",
                "readingNum": 1,
                "likeNum": 0,
                "introduction": null,
                "followWords": null,
                "followPic": null,
                "isFollowing": false,
                "isLike": false,
                "isSelf": false,
                "type": 1,
                "isVisible": true,
                "invisibleReason": null,
                "writingColumn": {
                    "columnOutId": "ffe00cb8fcef4def81f23ac36ce58752",
                    "name": "默认专栏",
                    "briefIntro": "这是一个默认专栏",
                    "cover": "https://files.mdnice.com/common/community/default-column-cover.jpg",
                    "writingNum": 54,
                    "createTime": "2024-08-06 19:05"
                }
            }
        },
        "__N_SSP": true
    },
    "page": "/writing/[id]",
    "query": {
        "id": "fd46c72f863c4c269cd02503dc6e13a1"
    },
    "buildId": "ErZPkD4oq6iwH2nj6Dpcx",
    "isFallback": false,
    "gssp": true,
    "appGip": true
}